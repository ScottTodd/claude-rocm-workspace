---
repositories:
  - therock
---

# Build and Test ROCm Python Packages in CI

**Status:** In progress
**Priority:** P1 (High)
**Started:** 2026-01-21
**Issue:** https://github.com/ROCm/TheRock/issues/1559

## Overview

Build and test ROCm Python packages as part of CI, not just during PyTorch release builds. Issues like #1347 and #1552 have gone undetected because `rocm-sdk test` only runs during PyTorch release builds. This task uploads Python packages to S3 and adds a test workflow.

## Goals

- [ ] Upload Python packages from `build_portable_linux_python_packages.yml` to S3
- [ ] Upload Python packages from `build_windows_python_packages.yml` to S3
- [ ] Create pip-compatible index for each workflow run
- [ ] Add `test_rocm_wheels.yml` workflow to test packages with `rocm-sdk test`
- [ ] (Future) Extend `setup_venv.py` to install from workflow run S3 paths
- [ ] (Future) Trigger dev PyTorch builds and tests

## Context

### Background

Current state:
- `build_portable_linux_python_packages.yml` and `build_windows_python_packages.yml` build packages but don't upload
- Windows workflow runs `rocm-sdk test` locally but Linux doesn't (Docker issues)
- Both workflows have `TODO(#1559)` comments for S3 upload
- `test_pytorch_wheels.yml` already installs packages from a pip index and runs tests

The desired workflow:
1. Build workflow builds Python packages
2. Build workflow creates pip index and uploads to S3
3. Test workflow installs from S3 pip index and runs `rocm-sdk test`

### Related Work

- **PR #3000:** `RunOutputRoot` class for CI run outputs paths (must land first)
- **PR #3099:** `test_rocm_wheels.yml` workflow (in review)
- **Task:** `run-outputs-layout.md` - defines S3 layout structure
- **Workflow:** `test_pytorch_wheels.yml` - pattern for testing wheels

### Directories/Files Involved

```
.github/workflows/build_portable_linux_python_packages.yml
.github/workflows/build_windows_python_packages.yml
.github/workflows/test_rocm_wheels.yml  # NEW
build_tools/_therock_utils/run_outputs.py
build_tools/setup_venv.py
build_tools/third_party/s3_management/   # existing tooling for deps index
docs/packaging/python_packaging.md
```

## Design

### S3 Layout for Python Packages

Two components: a **deps-only base index** (architecture-neutral, stable) and
**per-run indexes** (rocm packages only, per workflow run).

#### Base Index (deps only)

```
s3://therock-ci-artifacts/
└── python-deps/
    └── simple/                    # PEP 503 pip index
        ├── index.html
        ├── numpy/
        │   └── index.html
        ├── packaging/
        │   └── index.html
        └── ...                    # NO rocm packages
```

- Architecture-neutral (same deps for all GPU families)
- Managed by existing `update_dependencies.py` / `manage.py` tooling
- Contains only dependencies, never rocm packages

#### Per-Run Index (rocm packages only)

Aligned with `RunOutputRoot` layout:

```
s3://therock-ci-artifacts/
└── {run_id}-{platform}/
    └── python/{artifact_group}/
        ├── dist/
        │   ├── rocm-7.10.0.dev0.tar.gz
        │   ├── rocm_sdk_core-7.10.0.dev0-py3-none-linux_x86_64.whl
        │   ├── rocm_sdk_devel-7.10.0.dev0-py3-none-linux_x86_64.whl
        │   ├── rocm_sdk_libraries_gfx94X-7.10.0.dev0-py3-none-linux_x86_64.whl
        │   └── ...
        └── simple/               # pip index (generated by piprepo)
            ├── index.html
            ├── rocm/
            │   └── index.html
            ├── rocm-sdk-core/
            │   └── index.html
            └── ...               # ONLY rocm packages, no deps
```

### Pip Index Strategy

**Decision:** Deps-only base index + per-run rocm-only index.

**Rationale:** Version resolution. If we used `--extra-index-url=pypi.org` or
the nightly index, pip would see multiple versions of rocm packages and might
pick the wrong one. By having deps in one index and rocm packages in another,
pip can only find rocm packages in the per-run index.

**Installation:**

```bash
pip install rocm[libraries,devel] \
  --index-url=https://therock-ci-artifacts.s3.amazonaws.com/python-deps/simple/ \
  --extra-index-url=https://therock-ci-artifacts.s3.amazonaws.com/{run_id}-{platform}/python/{artifact_group}/simple/
```

**Alternatives considered:**

1. **Per-run index only + pypi.org** - Version ambiguity: pip might pick pypi's
   packages over our dev builds
2. **Per-run index only + nightly index** - Version ambiguity: pip might pick
   nightly's rocm packages over fresh dev builds
3. **Duplicate deps in every per-run index** - Wasteful, slower uploads

### RunOutputRoot Extensions

Add to `run_outputs.py`:

```python
# Python packages
def python_prefix(self, artifact_group: str) -> str:
    """S3 key prefix for Python packages directory."""
    return f"{self.prefix}/python/{artifact_group}"

def python_dist_prefix(self, artifact_group: str) -> str:
    """S3 key prefix for wheel/sdist files."""
    return f"{self.python_prefix(artifact_group)}/dist"

def python_index_prefix(self, artifact_group: str) -> str:
    """S3 key prefix for pip index (simple/ directory)."""
    return f"{self.python_prefix(artifact_group)}/simple"

def python_index_url(self, artifact_group: str) -> str:
    """Public URL for pip --index-url."""
    return f"{self.https_url}/python/{artifact_group}/simple/"
```

### Test Workflow Design

`test_rocm_wheels.yml`:

```yaml
inputs:
  amdgpu_family:
    description: GPU family to test
    type: string
  test_runs_on:
    description: Runner with GPU
    type: string
  package_run_id:
    description: Workflow run ID containing packages
    type: string
  package_version:
    description: Package version to install
    type: string
  artifact_group:
    description: Artifact group for index URL
    type: string

steps:
  - name: Set up venv and install packages
    run: |
      python build_tools/setup_venv.py .venv \
        --packages "rocm[libraries,devel]==${{ inputs.package_version }}" \
        --index-url "https://therock-ci-artifacts.s3.amazonaws.com/.../simple/" \
        --activate-in-future-github-actions-steps

  - name: Run rocm-sdk sanity tests
    run: rocm-sdk test
```

### setup_venv.py Extension (Future)

Add `--from-run-id` option:

```bash
python setup_venv.py .venv \
  --packages "rocm[libraries,devel]" \
  --from-run-id 12345678901 \
  --artifact-group gfx94X-dcgpu
```

This would compute the index URL automatically using `RunOutputRoot`.

## Investigation Notes

### 2026-01-21 - Initial Analysis

**Current workflow structure:**
- Both Linux and Windows workflows:
  1. Fetch artifacts from S3 (from a build workflow run)
  2. Build Python packages with `build_python_packages.py`
  3. Inspect packages (ls)
  4. Windows: sanity check with `piprepo build` + `pip install` + `rocm-sdk test`
  5. Linux: sanity check commented out (Docker issues)
  6. TODO: upload to S3

**Key observations:**
- `piprepo build` creates the pip-compatible index structure
- Need to upload both `dist/` (wheels/sdists) and `simple/` (index) directories
- Windows workflow already validates packages work locally
- Linux Docker container may need different approach for local testing

### 2026-01-26 - Created test_rocm_wheels.yml

Created `.github/workflows/test_rocm_wheels.yml` - a simplified version of `test_pytorch_wheels.yml`
that just installs ROCm packages and runs `rocm-sdk test`.

**Design decisions:**
- Uses existing `setup_venv.py` with `--index-url` and `--index-subdir` (reuses existing tooling)
- Deferred the "two-index pattern" - can test with nightly/dev release URLs for now
- Supports both `workflow_dispatch` (manual trigger) and `workflow_call` (can be called by other workflows)
- Uses same container image as `test_pytorch_wheels.yml` for Linux GPU runners
- Separate workflow file (vs inlining into build workflows) for better composability
  - Build workflows run on CPU runners; test needs GPU runners
  - Linux build can't run tests inline due to Docker issues
  - Separate workflow can test wheels from any source (nightly, dev, future CI uploads)

**Inputs:**
- `amdgpu_family` - GPU family (default: gfx94X-dcgpu)
- `test_runs_on` - Runner label (default: linux-mi325-1gpu-ossci-rocm-frac)
- `package_index_url` - Base URL (default: https://rocm.nightlies.amd.com/v2)
- `rocm_version` - Required, e.g., "7.10.0a20251124"
- `python_version` - Python version (default: 3.12)

**PR #3099** submitted for review.

**Next:** Wait for PR review, then test workflow manually with nightly wheels after merge.

## Implementation Plan

### Phase 1: S3 Upload from Build Workflows

1. **Extend `RunOutputRoot`** with Python package path methods (depends on PR #3000)
2. **Create upload helper** (or inline in workflow):
   - Run `piprepo build $PACKAGES_DIR/dist`
   - Upload `dist/` to S3 python packages path
   - Upload `simple/` to S3 pip index path
3. **Update Linux workflow** to call upload helper
4. **Update Windows workflow** to call upload helper
5. **Manual testing:** Download packages from S3, install manually, verify they work

### Phase 2: Base Deps Index Setup

1. **Create `python-deps/` in `therock-ci-artifacts`** bucket
2. **Run `update_dependencies.py`** to mirror deps (reuse existing tooling)
3. **Run `manage.py`** to generate index
4. **Verify** deps are accessible at expected URL

### Phase 3: Test Workflow

1. **Create `test_rocm_wheels.yml`**:
   - Similar to `test_pytorch_wheels.yml` but simpler (no PyTorch checkout)
   - Input: workflow run ID, artifact group, package version
   - Install packages from S3 pip index (using two-index pattern)
   - Run `rocm-sdk test`
2. **Add workflow_call support** so build workflows can trigger tests

### Phase 4: Integration

1. **Have build workflows call test workflow** after successful upload
2. **(Future) Extend `setup_venv.py`** with `--from-run-id` option

## Dependencies

- **PR #3000** (`RunOutputRoot`) must land first
- PR #3019 (`fetch_artifacts.py` refactor) would be nice but not blocking

## Next Steps

1. [x] Create task file
2. [ ] Wait for PR #3000 to land (or implement on top of `run-outputs` branch)
3. [ ] Design and implement S3 upload in build workflows
4. [x] Create test workflow (`test_rocm_wheels.yml`)
5. [ ] Test end-to-end (manually trigger with nightly wheels)
6. [x] Submit PR for test workflow - **PR #3099**

## Decisions Made

- **Bucket:** Same CI artifacts bucket (`therock-ci-artifacts`), with `python/{artifact_group}/`
  subdirectory for per-run packages and `python-deps/` for the base deps index
- **Index strategy:** Deps-only base index + per-run rocm-only index (avoids version ambiguity)
- **Base index:** Architecture-neutral, reuse existing `update_dependencies.py` / `manage.py` tooling
- **Linux sanity check:** Skip local testing, rely on GPU test workflow

## Open Questions

- Should test workflow run on PRs or only after merge?
  - **Leaning:** At least on merge; optionally on PRs with GPU runner availability
- Which deps to include in base index? Same as nightly, or a subset?
