# PR Review: #3608 ‚Äî Fix multi-arch Python packaging: per-family library dedup and per-family devel wheels

* **PR:** [#3608](https://github.com/ROCm/TheRock/pull/3608)
* **Author:** marbre
* **Branch:** `users/marbre/python-packaging` ‚Üí `main`
* **Reviewed:** 2026-02-25
* **Files changed:** 3 (+489, -36)
* **CI Run:** [22405547105](https://github.com/ROCm/TheRock/actions/runs/22405547105)

---

## Summary

This PR fixes two critical bugs in multi-architecture Python wheel builds (e.g. `gfx120X-all` + `gfx94X-dcgpu`):

1. **Empty library wheels**: A shared global `PopulatedFiles` tracker on `Parameters` caused whichever architecture iterated first to claim all shared relpaths (e.g. `lib/librocblas.so`), leaving other architectures with empty packages. Python set iteration order made this non-deterministic.

2. **Single devel wheel**: Only one `rocm-sdk-devel` package was generated using `params.default_target_family`, preventing other GPU families from getting usable devel packages.

The fix moves `PopulatedFiles` from `Parameters` (shared) to `PopulatedDistPackage` (per-instance), adds cross-package search helpers with target-family filtering, and produces per-family devel wheels in `dist/{target_family}/` subdirectories.

**Net changes:** +489 lines, -36 lines across 3 files

---

## Overall Assessment

**‚ö†Ô∏è CHANGES REQUESTED** ‚Äî The core code fix is sound, but per-family devel wheels break the flat find-links index, causing downstream pip installs to fail.

**Strengths:**

- Root cause analysis is clear and the fix directly addresses the dedup bug
- Architecture change is clean: per-instance tracking with cross-package search
- New test file covers both the unit-level bug fix and integration-level multi-arch behavior
- Build ordering is restructured to avoid accidental inclusion of devel dirs
- Removed pre-existing dead code (`build_args` double-assignment in `build_packages`)

**Blocking Issues:**

- Devel wheels in `dist/{target_family}/` subdirectories are not included in the flat `index.html` generated by the upload pipeline, making them invisible to `pip --find-links`

---

## CI Evidence

### Failures observed

| Job | Status | Failed Step | Duration |
|-----|--------|-------------|----------|
| Build PyTorch \| gfx110X-all \| torch release/2.10 \| py3.12 | **FAILURE** | Build PyTorch wheels | 13s |
| Test rocm[libraries,devel] wheels \| gfx120X-all | **FAILURE** | Setup venv and install 'rocm[libraries,devel]' | 41s |
| Build PyTorch \| gfx120X-all \| torch release/2.10 \| py3.12 | **FAILURE** | Build PyTorch wheels | (same pattern) |

### Control: non-devel tests pass

| Job | Status |
|-----|--------|
| Test rocm[libraries] wheels \| gfx120X-all | **SUCCESS** |
| Build Python \| gfx110X-all | **SUCCESS** |
| Build Python \| gfx120X-all | **SUCCESS** |

### Root cause analysis

1. **`build_python_packages.py`** now writes devel wheels to `dist/{target_family}/` (e.g. `dist/gfx110X-all/`) instead of `dist/`.

2. **The S3 upload IS recursive** ‚Äî devel wheels do get uploaded to S3. However, the **`index.html`** generated by `upload_python_packages.py` is flat, built from `find_package_files()` which uses non-recursive globs:
   ```python
   def find_package_files(dist_dir: Path) -> list[Path]:
       for pattern in ["*.whl", "*.tar.gz", "index.html"]:
           files.extend(dist_dir.glob(pattern))
   ```
   Devel wheels in subdirectories are uploaded but **not listed in the index**.

3. **`pip --find-links`** uses the index URL to discover available packages. Since the devel wheel isn't in the index, pip can't find it.

4. **Deeper issue ‚Äî package naming**: The devel `PackageEntry` template is `"rocm-sdk-devel"` (no `{target_family}` placeholder), unlike libraries which uses `"rocm-sdk-libraries-{target_family}"`. This means all per-family devel wheels produce the **same filename**, which is why the PR writes them to separate subdirectories ‚Äî they'd collide in a flat directory. But that breaks the flat index.

5. **PyTorch build** runs `pip install rocm[libraries,devel]` via `--find-links`, which fails because the devel wheel isn't in the index. The 13-second failure duration confirms this is an early pip resolution failure, not a compilation failure.

6. **Test Python (devel)** runs `pip install rocm[libraries,devel]` in a venv ‚Äî same failure for the same reason.

7. **Test Python (libraries-only)** passes because non-devel library wheels are still in `dist/`, listed in the index, and installable normally.

---

## Detailed Review

### 1. ‚ùå BLOCKING: Per-family devel packages break flat index and conflict with design intent

Two intertwined issues:

**CI breakage (immediate):** Per-family devel wheels are written to `dist/{target_family}/` subdirectories, which the flat `index.html` doesn't include. Downstream `pip --find-links` can't find them.

**Design conflict (needs discussion):** The `devel` `PackageEntry` is intentionally NOT target-specific ‚Äî its template is `"rocm-sdk-devel"` (no `{target_family}` placeholder), and `is_target_specific` returns `False`. The [packaging docs](https://github.com/ROCm/TheRock/blob/main/docs/packaging/python_packaging.md) describe devel as "the catch-all for everything" (singular) and state that "target specific packages are suffixed with their target family" ‚Äî a pattern that currently applies only to runtime library packages, not devel. The old code's use of `default_target_family` in the filter was a known simplification (only one family's link stubs), not a bug in the packaging model.

The PR creates per-family devel packages, which breaks this design boundary. The subdirectory workaround is needed because all families produce the same filename (`rocm_sdk_devel-*.whl`), but the real question is whether devel *should* become family-specific. Note also the docs' stated future direction: "this will be re-arranged to have more of a thin structure where the host code is always emitted as target neutral and separate device code packages are loaded as needed" ‚Äî which suggests further separation of host vs device code, but doesn't envision per-family devel packages.

**Options (need design discussion):**
- **(a) Make devel explicitly target-specific:** Change template to `"rocm-sdk-devel-{target_family}"`, update `rocm[devel]` extras resolution, and update downstream consumers. This is a deliberate design change that should be agreed upon.
- **(b) Keep devel as a single package with all families:** Include all families' link stubs in one devel package (perhaps namespaced by family within the tarball). Preserves the current design boundary but needs changes to the tarball structure and runtime extraction.
- **(c) Keep devel as a single package, pick one family (status quo ante):** Accept the limitation. The old `default_target_family` behavior was already shipping. Multi-family devel support becomes a separate design effort.

**Required action:** Resolve the design question about whether devel should become target-specific before landing this PR. The per-instance `PopulatedFiles` fix (part 1 of the PR) could potentially be split out and landed independently, since the library wheel dedup fix is valuable on its own.

### 2. py_packaging.py ‚Äî Core Fix: Per-Instance `PopulatedFiles`

#### ‚úÖ Correct: `PopulatedFiles` moved to `PopulatedDistPackage`

The central change is moving `self.files = PopulatedFiles()` from `Parameters.__init__` to `PopulatedDistPackage.__init__`. This ensures each package tracks its own materialized files independently, eliminating the cross-architecture interference bug.

All references updated consistently:
- `self.params.files` ‚Üí `self.files` in `populate_runtime_files`, `_populate_runtime_symlink`, `_populate_file`
- `self.params.files.soname_aliases` ‚Üí `self.files.soname_aliases`
- `self.params.files.mark_populated` ‚Üí `self.files.mark_populated`

#### ‚úÖ Correct: Package self-registration

`self.params.populated_packages.append(self)` at the end of `populate_runtime_files()` ensures only fully-populated packages are searchable. Packages that don't call `populate_runtime_files()` (like `meta`) are correctly excluded from cross-package searches.

#### ‚úÖ Correct: `_find_populated()` and `_find_soname_alias()`

The target-family filtering logic is sound:
- Skips packages from a *different* non-None target family
- Includes packages with matching target family
- Includes generic packages (`target_family=None`) for arch-neutral content (e.g. core)
- Returns first match, which is correct since within a family there should be at most one package owning a given relpath

#### ‚ö†Ô∏è IMPORTANT: Stale comment in `_devel_artifact_filter`

The filter now uses `self.target_family` instead of `self.params.default_target_family`, but the comment still says "We only materialize the default target family for devel packages." This is misleading since each devel package now filters to *its own* target family.

**Recommendation:** Update the comment to reflect the new behavior, e.g.:
```python
if (
    an.target_family != "generic"
    and an.target_family != self.target_family
):
    # Only include artifacts for this devel package's target family.
    return False
```

#### ‚úÖ Correct: `_populate_devel_file` updates

The switch from `self.params.files.soname_aliases.get(relpath)` to `self._find_soname_alias(relpath)` and from `self.params.files.has(relpath)` to `self._find_populated(relpath)` is clean. The destructured `populated_package, populated_path = populated` maintains the same interface used for symlink construction.

### 3. py_packaging.py ‚Äî `build_packages()` Refactoring

#### ‚úÖ Correct: New optional parameters

Adding `package_dirs` and `dist_dir` parameters with sensible defaults (scan `dest_dir` / use `dest_dir/dist`) maintains backward compatibility while enabling per-family builds.

#### ‚úÖ Good: Dead code removal

The old double-assignment of `build_args` (first with `python -m build`, then immediately overwritten with `setup.py`) is cleaned up. Only the `setup.py` invocation remains.

#### üí° SUGGESTION: `effective_dist_dir` naming

The `effective_dist_dir` variable name is fine but slightly verbose. Consider just `dist_dir` with early reassignment:
```python
if dist_dir is None:
    dist_dir = dest_dir / "dist"
dist_dir.mkdir(parents=True, exist_ok=True)
```
This is minor and entirely optional.

### 4. build_python_packages.py ‚Äî Build Orchestration

#### ‚úÖ Correct: Sorted iteration

`sorted(params.all_target_families)` ensures deterministic iteration order. Previously `params.all_target_families` came from a set, so iteration order was non-deterministic ‚Äî the same root cause as the dedup bug.

#### ‚úÖ Good: Build ordering change

Building non-devel wheels first (before devel package directories exist) prevents the default `dest_dir.iterdir()` scan from accidentally picking up devel packages. The comment explaining this is clear and helpful.

#### ‚úÖ Correct: Per-family devel packages

Each target family now gets its own devel package with the explicit `package_dirs=[devel.path]` ensuring only the current family's devel package is built in each iteration. The per-family `dist_dir` is the root cause of the CI failure (see blocking issue above).

#### üí° SUGGESTION: Consider guarding against ordering regressions

The correctness of the non-devel build depends on devel package directories not existing yet. If someone later moves code around, this invariant could break silently. One lightweight option would be to pass `package_dirs` explicitly for the non-devel build too, rather than relying on filesystem scanning.

### 5. py_packaging_test.py ‚Äî Test Suite

#### ‚úÖ Good: `PopulatedFilesTest`

Tests per-instance isolation directly, including:
- `test_two_instances_are_independent` ‚Äî the regression test for the bug
- `test_soname_aliases_are_per_instance`
- `test_mark_populated_raises_on_duplicate`

#### ‚úÖ Good: `MultiArchPackagingTest`

Integration tests use real artifact directories with `.txt` file stand-ins. Tests cover:
- Shared relpaths across architectures
- Package self-registration
- Cross-package search with `_find_populated` and `_find_soname_alias`
- Target-family filtering (matching family, different family, generic fallback)

#### üí° SUGGESTION: Consider a negative test for `_find_populated` with wrong family

There's `test_find_populated_prefers_matching_target_family` which tests that the *correct* family is returned. Consider also testing that when *only* a wrong-family package has a relpath, `_find_populated` returns `None` (rather than the wrong-family package). This would strengthen the guarantee that devel packages don't accidentally link to the wrong architecture's libraries.

---

## Recommendations

### ‚ùå REQUIRED (Blocking):

1. **Resolve per-family devel design conflict.** The PR creates per-family devel packages, conflicting with the established design where devel is a single non-target-specific package (see [python_packaging.md](https://github.com/ROCm/TheRock/blob/main/docs/packaging/python_packaging.md)). This also breaks the flat find-links index in CI. Consider splitting the PR: the `PopulatedFiles` per-instance fix (part 1 ‚Äî library dedup) is valuable and landable on its own; the per-family devel question needs a design discussion.

### ‚úÖ Recommended:

1. Update the stale comment in `_devel_artifact_filter` to reflect that each devel package filters to its own `self.target_family`, not the global default.

### üí° Consider:

1. Simplify `effective_dist_dir` naming in `build_packages()`.
2. Pass explicit `package_dirs` for non-devel builds to guard against future ordering regressions.
3. Add a negative test for `_find_populated` where only a wrong-family package has the relpath.

### üìã Future Follow-up:

1. The PR author notes that additional refactoring to the `rocm` sdist will be needed ‚Äî track as follow-up work.
2. The test suite uses `.txt` files as stand-ins for shared libraries, meaning soname/patchelf code paths aren't exercised end-to-end. Consider adding Linux-specific integration tests with real ELF binaries in the future.

---

## Testing Recommendations

- Run the new test suite: `python -m pytest build_tools/tests/py_packaging_test.py -v`
- After fixing the devel wheel location issue, re-run CI and verify:
  - `Test rocm[libraries,devel] wheels` passes (currently failing)
  - `Build PyTorch wheels` passes (currently failing at pip install after 13s)
  - All devel wheels appear in the S3 find-links index

---

## Conclusion

**Approval Status: ‚ö†Ô∏è CHANGES REQUESTED**

The PR has two logically separable parts: (1) the `PopulatedFiles` per-instance fix that solves the library wheel dedup bug ‚Äî this is architecturally sound and ready to land; (2) per-family devel packages ‚Äî this conflicts with the established design boundary where devel is a single non-target-specific package, and breaks the flat find-links index in CI. Consider splitting the PR so part 1 can land while the per-family devel design is discussed separately.
