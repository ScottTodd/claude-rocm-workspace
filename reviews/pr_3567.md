# PR #3567: Add support of python 3.11,3.13,3.14 for jax

**URL:** https://github.com/ROCm/TheRock/pull/3567
**Author:** JeniferC99
**Status:** Open (1 approval from kiran-thumma)
**CI Run:** https://github.com/ROCm/TheRock/actions/runs/22324002971

## Summary

One-line change: expands the Python version matrix in
`release_portable_linux_jax_wheels.yml` from `["3.12"]` to
`["3.11", "3.12", "3.13", "3.14"]`.

All 4 build jobs and 4 test jobs passed. The change is functionally correct.

---

## Review Findings

### ‚ùå BLOCKING

**(none)**

### ‚ö†Ô∏è IMPORTANT

#### 1. Commit hygiene: first commit title is misleading

The first commit (`9b74a404`) is titled "Add python 3.14 for **pytorch** and
3.11,3.13,3.14 for jax", but the PR only touches the JAX workflow. The second
commit (`b5364d30`) is titled "Update release_portable_linux_pytorch_wheels.yml"
and apparently reverted the pytorch change. This leaves a confusing commit
history. Should be squash-merged with a clean message like "Add Python 3.11,
3.13, 3.14 to JAX release workflow".

#### 2. Setuptools deprecation deadline: 2026-Mar-20 (24 days away)

All build jobs emit `SetuptoolsDeprecationWarning`:

```
SetuptoolsDeprecationWarning: Cannot find any files for the given pattern.
Pattern 'LICENSE.txt' did not match any files.
By 2026-Mar-20, you need to update your project and remove deprecated calls
or your builds will no longer be supported.
```

This fires during `jax-rocm-plugin` and `jax-rocm-pjrt` wheel builds. After
March 20, setuptools will make this a hard error and **all JAX wheel builds
will break** regardless of Python version. This isn't caused by this PR, but
this PR is adding 3 new variants that will all hit it. Whoever owns the
`rocm-jax` repo needs a tracking issue for this.

#### 3. Scott's feedback on motivation/framing (already raised in PR comments)

Scott's comment about the motivation being "flipped" is well-taken and hasn't
been fully addressed in the PR description. The motivation should be
user/developer-facing ("support recent Python versions that users expect"),
not internal-process-facing ("JIRA ticket says so for 7.12 Release").

### üí° SUGGESTION

#### 4. Build performance: ~51-72 min per variant, 4x cost increase

This PR quadruples the matrix from 1 to 4 Python versions. Each build takes
50-72 minutes on `azure-linux-scale-rocm` runners. The time variance is due
to runner hardware heterogeneity, not Python version differences (confirmed
by identical Bazel action counts and uniform slowdown across all phases
including the Python-independent Docker LLVM build).

Build time breakdown per variant:

| Phase | Time | % of Total |
|-------|------|------------|
| Docker LLVM 18 build from source | 9-13 min | ~18% |
| Bazel: jax-rocm-pjrt (`cub_sort_kernel_rocm.cu.cc` dominates) | 21-31 min | ~42% |
| Bazel: jaxlib | 12-17 min | ~23% |
| Bazel: jax-rocm-plugin | 3-4 min | ~6% |
| Docker setup, auditwheel, S3 upload | ~5 min | ~9% |

The single largest bottleneck is `cub_sort_kernel_rocm.cu.cc` which takes
**10-14 minutes** alone ‚Äî and it's compiling for **9 GPU targets** even though
the job specifies `amdgpu_family: gfx120X-all` (only gfx1200 + gfx1201).

The `amdgpu_family` input is never propagated to the Bazel build. The 9-target
list (`gfx908, gfx90a, gfx942, gfx950, gfx1030, gfx1100, gfx1101, gfx1200,
gfx1201`) is hardcoded in two places in `rocm-jax`:

1. **Dockerfile** (`Dockerfile.manylinux_2_28_x86_64.rocm`): writes a static
   `/opt/rocm/bin/target.lst` with all 9 targets
2. **`.bazelrc`** (`rocm_base` config): hardcodes
   `TF_ROCM_AMDGPU_TARGETS=gfx908,gfx90a,...,gfx1201`

The `ci_build` invocation in the workflow never passes the GPU family through.
The input is only used for tarball selection, S3 paths, and test runner
selection. With 2 targets instead of 9, the critical-path `cub_sort` compile
would drop from ~10-14 min to ~2-3 min, and the PJRT build phase would shrink
substantially. This is an upstream `rocm-jax` issue worth filing.

This is all pre-existing cost structure ‚Äî not introduced by this PR ‚Äî but
the 4x multiplier makes it worth noting. The LLVM-from-source Docker build
(9-13 min) is particularly wasteful since it's identical across all Python
versions and rebuilds every time (no Docker layer cache on ephemeral runners).

#### 5. Log noise: ~80% of build output is spam

The build logs are 24K+ lines each, of which ~80% is noise:

| Noise Source | Lines | Notes |
|---|---|---|
| LLVM build progress + install manifest | ~10K | `[XX%] Building...` + `-- Installing:` lines |
| Auditwheel DEBUG output | ~1.7K | Only jaxlib uses `-v`; plugin/pjrt don't |
| LLVM compiler warnings | ~584 | All `-Wattributes` and `-Wdangling-reference` from GCC 14 |
| Bazel progress for stuck actions | ~1.5K | `cub_sort_kernel_rocm.cu.cc` alone generates 1,489 progress lines |

The `auditwheel -v` inconsistency is notable: the jaxlib repair runs auditwheel
in verbose mode (dumping thousands of lines of dependency JSON), while the
plugin/pjrt repairs do not. These are upstream `rocm-jax` build script issues.

#### 6. Test job: InsecureRequestWarning spam

The test jobs emit `InsecureRequestWarning` on every S3 request from
`install_rocm_from_artifacts.py` (333 occurrences, ~22% of the 3K-line test
log). The script makes unverified HTTPS requests to
`therock-nightly-tarball.s3.amazonaws.com`.

#### 7. Duplicate wheel warnings

All variants emit warnings from `write_jax_versions.py`:

```
WARNING: Found multiple 'jaxlib' wheels matching...
WARNING: Found multiple 'jax_rocm7_plugin' wheels matching...
WARNING: Found multiple 'jax_rocm7_pjrt' wheels matching...
```

Both pre-auditwheel and post-auditwheel copies coexist in the wheelhouse.
The script picks the first match, which may be the wrong (non-manylinux) one.

#### 8. `rocm_plugin_extension not found` warning in tests

Tests log `WARNING: rocm_plugin_extension not found` at startup (3x per test
session). Tests still pass via a fallback path, but the warning is misleading
and could mask real issues.

#### 9. Python 3.14 tar extraction deprecation

Test logs show:

```
DeprecationWarning: Python 3.14 will, by default, filter extracted tar
archives and reject files or modify their metadata. Use the filter argument
to control this behavior.
```

From `install_rocm_from_artifacts.py:257`. Needs `filter='data'` argument
added to `extractall()` before Python 3.14 becomes the default.

### üìã FUTURE WORK

#### 10. Docker LLVM build caching

Building LLVM 18 from source identically on every run for every Python version
is the biggest low-hanging optimization. Options:

- Pre-built Docker base image with LLVM already installed
- Docker BuildKit layer caching across runs
- Separate LLVM build into a cacheable artifact

Would save 9-13 min per variant (36-52 min total across the 4-variant matrix).

#### 11. Propagate `amdgpu_family` to Bazel GPU targets

The biggest single optimization opportunity. The JAX build compiles every
`.cu.cc` file for 9 GPU targets regardless of the requested `amdgpu_family`.
For `gfx120X-all` jobs, this means 7 of the 9 target compilations are wasted.
Requires changes in `rocm-jax`:

- `ci_build` needs to accept and forward a target list
- The Dockerfile's `target.lst` generation needs to be parameterized
- The `.bazelrc` `rocm_base` config's `TF_ROCM_AMDGPU_TARGETS` needs to be
  overridable (or removed in favor of the runtime `target.lst`)

Estimated savings: ~60-70% of the PJRT build time (the 21-31 min phase),
since `cub_sort_kernel_rocm.cu.cc` dominates and scales linearly with targets.

#### 12. Bazel cache sharing across plugin/pjrt/jaxlib builds

Three separate Bazel server startups with no shared disk cache produce
~39,600 total actions per variant. Many of these are likely redundant
(protobuf, LLVM toolchain, etc.).

---

## Build Performance Comparison (all 4 variants)

| Variant | Build Step | Total Job | Runner |
|---------|-----------|-----------|--------|
| py3.13 | 50 min | 51 min | azure-...-m6qtx |
| py3.12 | 67 min | 68 min | azure-...-??? |
| py3.14 | 68 min | 69 min | azure-...-vbn27 |
| py3.11 | 71 min | 72 min | different runner |

py3.13 is the fast outlier due to runner lottery, not Python version advantage.

---

## Test Results (all variants passed)

| Variant | Tests Run | Skipped | Duration |
|---------|-----------|---------|----------|
| py3.13 | 1,482 | 11 | ~3 min |
| py3.12 | similar | similar | ~2.5 min |
| py3.14 | similar | similar | ~3 min |
| py3.11 | similar | similar | ~3 min |

Consistent skips: `test_lax_full_like_efficient` (multi-device),
`testTruncnormPdf{0-9}` (scipy compat).

---

## Bottom Line

The code change itself is trivially correct ‚Äî it's a matrix expansion. The
concerns are:

1. **Imminent:** Setuptools LICENSE.txt deprecation will break all JAX builds
   in 24 days (upstream `rocm-jax` issue, not this PR's fault, but this PR
   expands the blast radius 4x)
2. **Process:** Commit messages need cleanup; PR motivation framing per Scott's
   feedback
3. **Cost:** 4x runner cost increase, with known optimization opportunities
   in the build pipeline (GPU target propagation ‚Äî building for 9 targets
   instead of 2, Docker LLVM caching, Bazel cache sharing)
