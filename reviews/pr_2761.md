# Code Review: Enable CI to work on release branches

**PR:** #2761
**Branch:** (not specified in PR)
**Author:** HereThereBeDragons
**Reviewers:** ScottTodd, araravik-psd, marbre
**Reviewed:** 2026-01-06
**Status:** OPEN

## Summary

This PR aims to make GitHub Actions CI work out-of-the-box for all future `release/therock-*` branches, based on learnings from the `release/7.10` experience. The changes introduce a "long-lived branch" concept that treats both `main` and release branches similarly for CI purposes, running both presubmit and postsubmit jobs on push events. Additionally, it ensures that wheels are always promoted to the main repository on release branches, regardless of test results.

**Changes:**
- Add `release/therock-*` branch pattern to CI workflow triggers
- Introduce "long-lived branch" logic to run both presubmit and postsubmit jobs on release branches
- Force wheel uploads on release branches independent of test results
- Switch from `GITHUB_REF` to `GITHUB_REF_NAME` for branch name extraction

**Lines changed:** +33 / -9

---

## Review Results

### ‚ùå BLOCKING Issues

#### 1. Critical Bug: Missing branch_name Assignment (configure_ci.py:730-733)

**File:** `build_tools/github_actions/configure_ci.py`
**Location:** Lines 730-733

**Issue:**
The PR removes the line that assigns `base_args["branch_name"]`:

```python
# OLD (DELETED):
base_args["branch_name"] = os.environ.get("GITHUB_REF").split("/")[-1]

# NEW (ADDED):
branch = os.environ.get("GITHUB_REF_NAME", "")
if branch == "":
    print("[WARNING] GITHUB_REF_NAME is not set!", file=sys.stderr)
# ‚ö†Ô∏è MISSING: base_args["branch_name"] = branch
```

The new code reads `GITHUB_REF_NAME` into a local variable `branch` and validates it, but **never assigns it to `base_args["branch_name"]`**. This means the entire CI configuration logic that depends on `base_args["branch_name"]` will break, as it will be `None` or missing from the dictionary.

**Impact:**
- The `is_long_lived_branch` check on lines 387-393 will fail because `base_args.get("branch_name")` returns `None`
- The branch name logging on lines 499-500 will display `None`
- Any downstream logic depending on knowing the branch name will break

**Fix Required:**
```python
branch = os.environ.get("GITHUB_REF_NAME", "")
if branch == "":
    print("[WARNING] GITHUB_REF_NAME is not set!", file=sys.stderr)
base_args["branch_name"] = branch  # ‚Üê ADD THIS LINE
```

---

#### 2. Missing f-string Prefix (promote_wheels_based_on_policy.py:27)

**File:** `build_tools/github_actions/promote_wheels_based_on_policy.py`
**Location:** Line 27 (in the diff)

**Issue:**
The print statement is missing the `f` prefix for f-string formatting:

```python
print(
    "::notice::On release branch: {branch}. Forcing upload independent of test results."
)
```

This will print the literal string `{branch}` instead of the actual branch name.

**Fix Required:**
```python
print(
    f"::notice::On release branch: {branch}. Forcing upload independent of test results."
)
```

---

### ‚ö†Ô∏è IMPORTANT Issues

#### 3. Inconsistent Branch Name Sanitization

**Files:** `configure_ci.py`, `promote_wheels_based_on_policy.py`

**Issue:**
The old code used `os.environ.get("GITHUB_REF").split("/")[-1]` which extracts just the branch name from refs like `refs/heads/release/therock-7.11`. The new code uses `GITHUB_REF_NAME` which should already contain just the branch name.

However, this creates an inconsistency:
- Old approach: `refs/heads/release/therock-7.11` ‚Üí splits to `therock-7.11`
- New approach: `GITHUB_REF_NAME` contains `release/therock-7.11`

This means the old code would extract `therock-7.11` while the new code gets `release/therock-7.11`. The prefix matching logic checks for `release/therock-` which works, but:
1. The exact match check for `"main"` needs to also handle `refs/heads/main` if the old variable is still used elsewhere
2. If `GITHUB_REF_NAME` is not set (as the warning suggests could happen), fallback behavior is undefined

**Recommendation:**
- Verify that `GITHUB_REF_NAME` is consistently available in all GitHub Actions contexts (PRs, pushes, scheduled runs)
- Consider adding a fallback: `branch = os.environ.get("GITHUB_REF_NAME", "") or os.environ.get("GITHUB_REF", "").split("/")[-1]`
- Document the expected format and any environment differences

---

#### 4. Silent Failure on Missing GITHUB_REF_NAME

**File:** `build_tools/github_actions/configure_ci.py`
**Location:** Lines 732-733

**Issue:**
When `GITHUB_REF_NAME` is empty, the code only prints a warning to stderr but continues execution with an empty string:

```python
branch = os.environ.get("GITHUB_REF_NAME", "")
if branch == "":
    print("[WARNING] GITHUB_REF_NAME is not set!", file=sys.stderr)
# Execution continues with branch = ""
```

An empty `branch_name` will cause the `is_long_lived_branch` check to fail silently, and the branch will be treated as a non-long-lived branch.

**Recommendation:**
Either:
1. Fail fast with an exception if `GITHUB_REF_NAME` is missing and no fallback is available
2. Provide a fallback to the old `GITHUB_REF` variable
3. Make the warning more prominent (use `::error::` instead of stderr)

Example:
```python
branch = os.environ.get("GITHUB_REF_NAME", "")
if not branch:
    # Fallback to old method
    github_ref = os.environ.get("GITHUB_REF", "")
    if github_ref:
        branch = github_ref.split("/")[-1]
    else:
        raise ValueError("Neither GITHUB_REF_NAME nor GITHUB_REF is set in the environment")
```

---

#### 5. Wheel Promotion Logic Bypasses All Safety Checks

**File:** `build_tools/github_actions/promote_wheels_based_on_policy.py`
**Location:** Lines 24-30

**Issue:**
The new logic unconditionally promotes wheels on release branches, even if:
- The build failed completely
- Tests crashed or encountered errors
- The artifacts are corrupted or incomplete

```python
if branch.startswith("release/therock-"):
    print(...)
    upload = "true"
elif build_result != "success":  # This check is now bypassed for release branches
    print("::warning::Build failed. Skipping upload.")
```

While this may be intentional based on the PR description ("packages are always promoted"), it's a significant change from the existing safety guardrails.

**Recommendation:**
- Add a comment explaining why this is safe/acceptable for release branches
- Consider at minimum checking that `build_result == "success"` even on release branches
- Document this behavior in release documentation
- Consider adding a manual approval step or safety check

Alternative approach:
```python
# Check release branch first, but still require successful build
if branch.startswith("release/therock-"):
    if build_result != "success":
        print("::error::Build failed on release branch. Manual intervention required.")
        upload = "false"
    else:
        print(f"::notice::On release branch: {branch}. Promoting despite test results.")
        upload = "true"
```

---

### üí° SUGGESTIONS

#### 6. Add Unit Tests for Long-Lived Branch Detection

**File:** `build_tools/github_actions/configure_ci.py`
**Location:** Lines 383-394

**Suggestion:**
The new `is_long_lived_branch` logic has two types of matching (full match and prefix match) but no tests to verify the behavior. Consider adding unit tests covering:
- `branch_name = "main"` ‚Üí `is_long_lived_branch = True`
- `branch_name = "release/therock-7.11"` ‚Üí `is_long_lived_branch = True`
- `branch_name = "release/therock"` ‚Üí `is_long_lived_branch = False` (no trailing segment)
- `branch_name = "feature/my-work"` ‚Üí `is_long_lived_branch = False`
- `branch_name = "main-test"` ‚Üí `is_long_lived_branch = False`
- `branch_name = None` ‚Üí Should handle gracefully

---

#### 7. Improve Variable Naming

**File:** `build_tools/github_actions/configure_ci.py`
**Location:** Lines 386-388

**Suggestion:**
The variable names could be more descriptive:

```python
# Current:
long_lived_full_match = ["main"]
long_lived_prefix_match = ["release/therock-"]

# Suggested:
long_lived_branch_names = ["main"]
long_lived_branch_prefixes = ["release/therock-"]
```

This makes it clearer that one is exact matches and the other is prefix matches.

---

#### 8. Extract Magic Strings to Constants

**File:** Multiple files

**Suggestion:**
The string `"release/therock-"` appears in multiple places:
- `configure_ci.py:388`
- `promote_wheels_based_on_policy.py:25`

Consider extracting to a shared constant:

```python
# In a shared config file or at the top of both files:
RELEASE_BRANCH_PREFIX = "release/therock-"
```

This ensures consistency and makes updates easier.

---

#### 9. Add Logging for Long-Lived Branch Detection

**File:** `build_tools/github_actions/configure_ci.py`
**Location:** Lines 383-394

**Suggestion:**
Add debug logging to make it easier to troubleshoot CI issues:

```python
if base_args.get("branch_name") in long_lived_full_match or any(
    base_args.get("branch_name", "").startswith(prefix)
    for prefix in long_lived_prefix_match
):
    is_long_lived_branch = True
    print(f"[INFO] Branch '{base_args.get('branch_name')}' detected as long-lived")
else:
    is_long_lived_branch = False
    print(f"[INFO] Branch '{base_args.get('branch_name')}' is not long-lived")
```

---

#### 10. Document the New Behavior

**Suggestion:**
Add documentation explaining:
1. What "long-lived branches" are (main + release branches)
2. How they differ from feature/fix branches in CI behavior
3. The wheel promotion policy for release branches
4. Why tests can be bypassed on release branches

This could be in:
- A comment block in the affected Python files
- A docs file like `docs/ci/release-branches.md`
- The TheRock repository README or CI documentation

---

### üìã FUTURE WORK

#### 11. Consider Parameterizing Release Branch Pattern

Currently the release branch pattern is hardcoded as `release/therock-*`. In the future, consider making this configurable via:
- A GitHub Actions workflow input
- A configuration file
- An environment variable

This would allow flexibility for different release naming schemes without code changes.

---

#### 12. Add CI Job to Validate Script Behavior

Consider adding a CI job that runs the Python scripts with various test inputs to catch bugs like the missing assignment before they reach production.

---

## Detailed Analysis

### Architecture

**Approach:** The PR introduces a "long-lived branch" concept to distinguish between:
1. **Long-lived branches:** `main` and `release/therock-*` - run both presubmit and postsubmit jobs on push
2. **Short-lived branches:** All others - run only presubmit jobs on push

This is a clean abstraction that makes the code more maintainable than hardcoding "main" checks everywhere.

**Design:** The separation of full-match vs prefix-match lists is good and allows easy extension.

**Concerns:**
- The implementation has critical bugs (missing assignment, missing f-string)
- The branch name extraction change may have unintended consequences
- The unconditional wheel promotion on release branches removes important safety checks

---

### Testing

**Current CI Status:**
- Overall: FAIL
- Windows::gfx110X-all build: FAIL
- Windows::gfx1151 miopen_plugin test: FAIL
- Many Linux/Windows tests: PASS

The failures suggest there may be issues with the PR, though they could also be pre-existing or unrelated.

**Testing Gaps:**
- No unit tests for the new `is_long_lived_branch` logic
- No validation that the branch name is correctly extracted
- No tests for the wheel promotion policy changes

**Recommendation:** Add automated tests and manually verify on a test release branch before merging.

---

### Style & Code Quality

**Positive:**
- Code follows existing patterns in the files
- Variable names are generally clear
- Comments explain the intent

**Issues:**
- Missing f-string prefix (blocking bug)
- Missing variable assignment (critical blocking bug)
- Magic strings could be extracted to constants

---

### Security

**No security vulnerabilities identified.**

The changes deal with CI configuration and don't introduce security risks. The wheel promotion logic change is a policy decision rather than a security issue.

---

### Performance

**No performance concerns.**

The changes are configuration logic that runs once per CI job and have negligible performance impact.

---

## CI Failures Investigation

The PR shows several CI failures:
1. **CI Summary:** fail
2. **Windows::gfx110X-all::release build:** fail (4m36s)
3. **Windows::gfx1151::release miopen_plugin test:** fail (1m36s)

These failures should be investigated to determine if they're caused by this PR or are pre-existing issues. The critical bug (missing branch_name assignment) could be causing the CI Summary failure.

---

## Verdict

**‚ùå CHANGES REQUIRED**

This PR has good intentions and a solid architectural approach, but contains **two critical blocking bugs** that will break CI:

1. **Missing `base_args["branch_name"]` assignment** - Will cause all branch name checks to fail
2. **Missing f-string prefix** - Will print literal `{branch}` instead of branch name

These must be fixed before the PR can be merged. Additionally, the unconditional wheel promotion on release branches should be carefully reviewed to ensure it's the right tradeoff between convenience and safety.

**Recommended Next Steps:**
1. Fix the two blocking bugs
2. Verify behavior on a test release branch
3. Add unit tests for the long-lived branch detection
4. Document the new release branch behavior
5. Consider adding a minimum safety check (successful build) before promoting wheels

Once the blocking issues are addressed, this will be a valuable improvement for release branch CI workflow.
