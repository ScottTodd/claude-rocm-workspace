# Code Review: Enable CI to work on release branches

**PR:** https://github.com/ROCm/TheRock/pull/2761
**Author:** Laura Promberger (@HereThereBeDragons)
**Issue:** #2630
**Reviewed:** 2026-01-08
**Status:** OPEN
**Previous Review:** 2026-01-06 (blocking issues now resolved)

## Summary

This PR enables GitHub Actions CI to work automatically on `release/therock-*` branches based on experience from release/7.10. The changes introduce a "long-lived branch" concept (main + release branches) that triggers both presubmit and postsubmit jobs on push, and ensures packages are always promoted on release branches regardless of test results.

**Changes:**
- Add `release/therock-*` branch pattern to CI workflow triggers
- Introduce `determine_long_lived_branch()` function to classify branches
- Run both presubmit and postsubmit jobs on release branches (like main)
- Force wheel uploads on release branches independent of test results
- Switch from parsing `GITHUB_REF` to using `GITHUB_REF_NAME` directly

**Lines changed:** +97 / -9

---

## Status Update Since Previous Review

The previous review (2026-01-06) identified two **critical blocking bugs** that have since been **fixed**:

1. ‚úÖ **Fixed:** `base_args["branch_name"]` is now correctly assigned from `GITHUB_REF_NAME`
2. ‚úÖ **Fixed:** f-string prefix added to the branch name logging in `promote_wheels_based_on_policy.py`

Additional improvements made:
- Error handling improved: now exits with error (not just warning) if `GITHUB_REF_NAME` is missing
- Unit tests added for `determine_long_lived_branch()` function

---

## Current State Review

### ‚úÖ STRENGTHS

#### 1. Clean Abstraction
The `determine_long_lived_branch()` function provides a testable, reusable way to classify branches:

```python
def determine_long_lived_branch(branch_name: str) -> bool:
    is_long_lived_branch = False
    long_lived_full_match = ["main"]
    long_lived_prefix_match = ["release/therock-"]
    if branch_name in long_lived_full_match or any(
        branch_name.startswith(prefix) for prefix in long_lived_prefix_match
    ):
        is_long_lived_branch = True
    return is_long_lived_branch
```

This separates policy (which branches are long-lived) from implementation (how CI treats them).

#### 2. Good Test Coverage
The `test_determine_long_lived_branch()` test covers:
- Positive cases: `main`, `release/therock-7.9`, `release/therock-100`, edge case `release/therock-`
- Negative cases: `users/test`, `release/therock` (missing dash), `main-test`, `newfeature`, `release/main`

Edge cases are well-tested.

#### 3. Improved Environment Variable Handling
Using `GITHUB_REF_NAME` directly instead of parsing `GITHUB_REF` is cleaner:

```python
base_args["branch_name"] = os.environ.get("GITHUB_REF_NAME", "")
if base_args["branch_name"] == "":
    print("[ERROR] GITHUB_REF_NAME is not set! No branch name detected. Exiting.", file=sys.stderr)
    sys.exit(1)
```

Fail-fast behavior is correct - exits immediately if branch name cannot be determined.

#### 4. Clear Documentation in Code
Comments explain the rationale for policy decisions, especially for the controversial "always upload on release" behavior:

```python
# 0) If on a release branch, always upload, as
#    - Release branch has already been tested
#    - Flaky tests can prevent promotion, as such ignore test results
#    - Will insure that QA/engineers have a single point of truth to get the packages, which isnt staging
```

---

### ‚ö†Ô∏è CONCERNS

#### 1. Unconditional Wheel Promotion on Release Branches

**File:** `promote_wheels_based_on_policy.py`
**Location:** Lines 24-32

The most significant behavioral change is unconditional package promotion on release branches:

```python
if branch.startswith("release/therock-"):
    print(f"::notice::On release branch: {branch}. Forcing upload independent of test results.")
    upload = "true"
elif build_result != "success":
    print("::warning::Build failed. Skipping upload.")
```

**Analysis:**
- This bypasses **all** safety checks, including build failures
- Even if the build fails completely (not just tests), packages are promoted
- This is explicitly called out in the PR description, so appears intentional

**Risk Assessment:**
- **High risk:** Broken packages could be promoted to the main repository
- **Mitigation factors:**
  - Release branches are presumably tested before creation
  - Comment suggests this addresses pain from flaky tests in release/7.10
  - QA/engineers need single source of truth (not staging)

**Recommendation:**
Consider whether at minimum the build should succeed before promotion:

```python
if branch.startswith("release/therock-"):
    if build_result != "success":
        print("::error::Build failed on release branch. Skipping upload even on release.")
        upload = "false"
    else:
        print(f"::notice::On release branch: {branch}. Uploading despite test results.")
        upload = "true"
```

**However**, the current behavior may be intentional if:
- Release branch builds are from known-good commits
- The team accepts that occasional broken packages on release branches are preferable to missed promotions
- There's a downstream QA process that catches issues

**Decision needed:** Clarify with team whether build failures should also be bypassed.

---

#### 2. Edge Case: `release/therock-` (Empty Suffix)

**File:** `configure_ci_test.py`
**Location:** Test cases

The test explicitly validates that a branch named exactly `release/therock-` (with nothing after the dash) is considered long-lived:

```python
for branch in [
    "main",
    "release/therock-7.9",
    "release/therock-",      # ‚Üê This one
    "release/therock-100",
]:
    self.assertTrue(configure_ci.determine_long_lived_branch(branch))
```

**Question:** Is this intentional? Is there ever a branch named exactly `release/therock-`?

**Impact:** Low - unlikely anyone creates this branch, but if they do, it would unexpectedly get release treatment.

**Recommendation:** If this is not a realistic scenario, consider requiring at least one character after the dash:
```python
import re
if re.match(r"release/therock-.+", branch_name):
    is_long_lived_branch = True
```

But given the low risk, the current implementation is probably fine.

---

#### 3. Duplicate Branch Pattern String

**Files:** `configure_ci.py`, `promote_wheels_based_on_policy.py`

The string `"release/therock-"` appears in multiple places:
- `configure_ci.py:388`
- `promote_wheels_based_on_policy.py:28`

**Risk:** If the release branch naming convention changes, both files must be updated.

**Recommendation:** Extract to a shared constant:
```python
# In a shared constants file or at the top of both modules
RELEASE_BRANCH_PREFIX = "release/therock-"
```

**Priority:** Low - but good practice for maintainability.

---

### üí° SUGGESTIONS

#### 4. Variable Naming Clarity

**File:** `configure_ci.py`
**Location:** Lines 369-370

Current:
```python
long_lived_full_match = ["main"]
long_lived_prefix_match = ["release/therock-"]
```

Suggested:
```python
LONG_LIVED_BRANCH_NAMES = ["main"]
LONG_LIVED_BRANCH_PREFIXES = ["release/therock-"]
```

**Rationale:**
- Constants for configuration values
- Clearer distinction between exact matches and prefix matches
- More descriptive names

---

#### 5. Integration Testing

**Gap:** No integration tests verify that:
- A push to `release/therock-7.11` actually generates the expected matrix
- Wheel promotion actually triggers correctly on release branches
- The full workflow works end-to-end

**Recommendation:** Add an integration test or manually verify on a test release branch before merging.

---

#### 6. Documentation

**Missing:** Documentation explaining the new behavior:
1. What "long-lived branches" are
2. How they differ in CI behavior
3. The wheel promotion policy for release branches
4. Why this approach was chosen

**Recommendation:** Add to:
- TheRock CI documentation
- Or a comment block in the workflow file
- Or `docs/ci/release-branches.md`

---

## Code Quality

**Style:** ‚úÖ Follows project conventions
- Consistent with existing code patterns
- Proper error handling (fail-fast on missing env vars)
- Clear variable names

**Type Hints:** ‚úÖ Present where appropriate
```python
def determine_long_lived_branch(branch_name: str) -> bool:
```

**Comments:** ‚úÖ Adequate
- Explains rationale for policy decisions
- Documents complex logic

**Testing:** ‚ö†Ô∏è Unit tests present, integration tests missing
- Good unit test for `determine_long_lived_branch()`
- Missing integration/end-to-end tests

---

## Security

**No security vulnerabilities identified.**

The changes are configuration logic with no security implications.

---

## Performance

**No performance concerns.**

Configuration logic runs once per CI job - negligible impact.

---

## CI Status

**Current status:** Some checks pending, some passing.

Notable:
- `pre-commit`: ‚úÖ pass
- Multiple Linux builds: ‚úÖ pass
- Windows builds: ‚è≥ pending
- Some tests: ‚è≥ pending

No obvious failures related to this PR's changes.

---

## Verdict

**‚úÖ APPROVE with recommendations**

The critical blocking bugs from the previous review have been fixed. The PR is now technically sound and achieves its stated goals.

**Remaining concerns are policy decisions, not bugs:**

1. **Unconditional wheel promotion** - The most significant change is promoting packages even on build/test failures for release branches. This appears intentional based on the PR description and issue #2630, but should be confirmed with the team.

2. **Code quality improvements** - Extract magic strings to constants, improve variable naming - these are nice-to-haves, not blockers.

3. **Documentation** - Would benefit from documenting the new release branch behavior.

**Recommendation:**
- Approve and merge if the team confirms the unconditional promotion policy is correct
- Consider the code quality improvements in a follow-up PR
- Add documentation for the new behavior

**Risk Assessment:**
- **Low technical risk** - Code is correct, tested, and follows project patterns
- **Medium policy risk** - Unconditional promotion could allow broken packages, but this appears to be an accepted tradeoff based on release/7.10 experience

The PR successfully addresses the pain points from release/7.10 and provides a clean abstraction for release branch CI configuration.
