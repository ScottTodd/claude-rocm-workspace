# PR Review: #3481 ‚Äî Run Linux Nightly Package Build Entirely Inside Container

* **PR:** [#3481](https://github.com/ROCm/TheRock/pull/3481)
* **Author:** chiranjeevipattigidi (chiranjeevi-amd)
* **Branch:** `users/cpattigi-amd/linux-nightly-container` ‚Üí `main`
* **Reviewed:** 2026-02-18
* **Files changed:** 2

---

## Summary

This PR migrates `release_portable_linux_packages.yml` from docker-in-docker
execution (via `linux_portable_build.py` ‚Üí `linux_portable_build_in_container.sh`)
to using the native GitHub Actions `container:` directive. This aligns the
release workflow with how `build_portable_linux_artifacts.yml` (CI) already
works. It also adds a `--build-dir` CLI argument to `build_configure.py`.

**Net changes:** +38 lines, -25 lines across 2 files

---

## Overall Assessment

**‚ö†Ô∏è CHANGES REQUESTED** ‚Äî The migration direction is correct and follows
established patterns in the CI workflows. However, there are important gaps
in the migration that could cause regressions.

**Strengths:**

- Correct direction: removes docker-in-docker indirection, aligning with CI
  patterns used by `build_portable_linux_artifacts.yml`
- Eliminates the need for `Grant ownership over output directory` step (since
  everything now runs inside the container natively)
- Proper addition of `AWS_SHARED_CREDENTIALS_FILE` and volume mount for
  credentials, matching `build_portable_linux_python_packages.yml` pattern
- Container image SHA is preserved, ensuring reproducibility
- Good that `build_configure.py` is reused (DRY) instead of duplicating cmake
  configuration logic

**Issues:**

- Missing ccache setup (build time regression)
- CMake configure flags differ from what the old script passed
- Minor cleanup gaps (dead code)

---

## Detailed Review

### 1. `release_portable_linux_packages.yml`

#### ‚ö†Ô∏è IMPORTANT: Missing ccache configuration

The old `linux_portable_build_in_container.sh` explicitly configured ccache:

```bash
export CCACHE_DIR="$OUTPUT_DIR/caches/container/ccache"
export PIP_CACHE_DIR="$OUTPUT_DIR/caches/container/pip"
mkdir -p "$CCACHE_DIR"
mkdir -p "$PIP_CACHE_DIR"
```

This ensured that:
1. ccache writes to `$OUTPUT_DIR/caches/container/ccache`
2. The `actions/cache` step (which saves/restores `$OUTPUT_DIR/caches`) captures
   ccache data across runs

The new workflow does not set `CCACHE_DIR` or `PIP_CACHE_DIR`. Without these:
- ccache will write to its default location (`~/.cache/ccache`), which is NOT
  within the cached `$OUTPUT_DIR/caches` path
- The `Enable cache`/`Save cache` steps become ineffective for ccache
- Every build becomes a full rebuild, significantly increasing build time

The CI workflow (`build_portable_linux_artifacts.yml`) handles this with
`setup_ccache.py` and explicit `CCACHE_CONFIGPATH`/`CACHE_DIR` env vars.

**Recommendation:** Either:
- Add `setup_ccache.py` setup like the CI workflow does, or
- Set `CCACHE_DIR` and `PIP_CACHE_DIR` env vars pointing within
  `$OUTPUT_DIR/caches`, or
- At minimum, document that ccache caching is intentionally not configured

---

#### ‚ö†Ô∏è IMPORTANT: `build_configure.py` adds `-DBUILD_TESTING=ON` that the old flow didn't have

The old `linux_portable_build_in_container.sh` cmake invocation:
```bash
cmake -GNinja -S /therock/src -B "$OUTPUT_DIR/build" \
  -DTHEROCK_BUNDLE_SYSDEPS=ON \
  -DTHEROCK_ENABLE_SYSDEPS_AMD_MESA=ON \
  ${PYTHON_EXECUTABLES_ARG} \
  ${PYTHON_SHARED_EXECUTABLES_ARG} \
  "$@"
```

The `build_configure.py` cmake invocation adds:
```python
"-DBUILD_TESTING=ON",
```

This flag was not present in the old release build flow. Enabling tests in
release builds:
- Increases build time (building test binaries)
- May not be desired for production release artifacts

If this is intentional (bringing the release build in line with CI), it should
be noted in the PR description. If not, consider whether `build_configure.py`
should conditionally add this flag.

**Recommendation:** Confirm whether `-DBUILD_TESTING=ON` is intentional for
release builds. If not, either make it configurable in `build_configure.py`
or pass `-DBUILD_TESTING=OFF` via `extra_cmake_options`.

---

#### üí° SUGGESTION: Dead `wait` command in Fetch sources

The `wait` command remains after removing the background `docker pull`:

```yaml
- name: Fetch sources
  timeout-minutes: 30
  run: |
    ./build_tools/fetch_sources.py --jobs 10
    wait  # <-- no background processes to wait for
```

**Recommendation:** Remove the `wait` command.

---

#### üí° SUGGESTION: Pass `--manylinux` explicitly for consistency

The CI workflow (`build_portable_linux_artifacts.yml`) passes `--manylinux`
explicitly:
```yaml
python3 build_tools/github_actions/build_configure.py --manylinux
```

The release workflow relies on the `MANYLINUX: 1` env var:
```yaml
python3 ./build_tools/github_actions/build_configure.py \
  --build-dir ${{ env.BUILD_DIR }}
```

While both work (the code checks both), explicit is better than implicit.

---

### 2. `build_tools/github_actions/build_configure.py`

#### ‚ö†Ô∏è IMPORTANT: `build_dir` removed from module scope creates inconsistency

The `build_dir` assignment was removed from module level:
```python
# Removed:
build_dir = os.getenv("BUILD_DIR")
```

And moved to `__main__`:
```python
build_dir = args.build_dir or os.getenv("BUILD_DIR")
```

This works because `if __name__ == "__main__"` is at module scope, so `build_dir`
becomes a module-level global. However:

1. **Inconsistency**: All other config variables (`cmake_preset`,
   `amdgpu_families`, `package_version`, `extra_cmake_options`, etc.) are still
   set at module level. `build_dir` now follows a different pattern.
2. **Fragile**: If `build_configure()` is ever called without going through
   `__main__` (e.g., imported from tests), it will get a `NameError`. The other
   module-level vars would be `None` but at least exist.

**Recommendation:** Keep `build_dir` at module level as the default, override
in `__main__` if CLI arg is provided:
```python
# Module level (keep):
build_dir = os.getenv("BUILD_DIR")

# In __main__ (add override):
if args.build_dir:
    build_dir = args.build_dir
```

---

#### üí° SUGGESTION: Consider refactoring all module-level globals

The entire module uses globals for configuration (`cmake_preset`,
`amdgpu_families`, etc.), which is fragile. This is a pre-existing issue,
but the `--build-dir` addition is an opportunity to start moving toward
passing configuration through function parameters or a config object.

This is out of scope for this PR but worth noting.

---

## Recommendations

### ‚ùå REQUIRED Before Human Review (Blocking):

None ‚Äî the build functions correctly as demonstrated by the test run.

### ‚úÖ Recommended Before Human Review:

1. **Add ccache configuration** ‚Äî Set `CCACHE_DIR` (and `PIP_CACHE_DIR`) to
   paths within `$OUTPUT_DIR/caches`, or adopt the `setup_ccache.py` pattern
   from the CI workflow.
2. **Confirm `-DBUILD_TESTING=ON` is intentional** for release builds. If not,
   pass `-DBUILD_TESTING=OFF` via `extra_cmake_options`.
3. **Keep `build_dir` at module level** in `build_configure.py` for consistency
   with the other config variables, and override in `__main__` when CLI arg is
   provided.

### üí° Consider:

1. Remove dead `wait` command from Fetch sources step.
2. Pass `--manylinux` explicitly in the workflow's Configure step.
3. Remove redundant `BUILD_DIR` job-level env var if only the `--build-dir` CLI
   arg is needed (or vice versa ‚Äî use only the env var for consistency with CI).

### üìã Future Follow-up:

1. Refactor `build_configure.py` to pass configuration through function
   parameters instead of module-level globals.
2. Evaluate whether `linux_portable_build.py` and
   `linux_portable_build_in_container.sh` can be deprecated now that both CI
   and release workflows use native `container:`. They still serve a purpose
   for local developer use, but the CI usage path is removed.

---

## Testing Recommendations

1. **Verify ccache hit rates** ‚Äî After adding ccache configuration, run the
   workflow twice and check ccache statistics (hit rate should be >0 on second
   run).
2. **Compare cmake configure flags** ‚Äî Run the old and new workflows with
   verbose cmake output and diff the cmake invocations to catch any missing
   flags.
3. **Verify artifact output** ‚Äî Compare the artifact directory structure and
   file list between old and new workflows to ensure nothing is missing.

---

## Conclusion

**Approval Status: ‚ö†Ô∏è CHANGES REQUESTED**

The migration from docker-in-docker to native `container:` is the right
direction and follows established patterns. The core build logic works
correctly as shown by the test run. However, the ccache configuration gap
will cause build time regressions for release iterations, and the
`-DBUILD_TESTING=ON` change should be explicitly acknowledged. With the
recommended fixes, this PR will be ready for merge.
