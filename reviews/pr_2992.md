# PR Review: #2992 - Add unit tests covering core packaging script functionality

* **PR:** [#2992](https://github.com/ROCm/TheRock/pull/2992)
* **Author:** raramakr
* **Branch:** `users/raramakr/unittest-pkg` -> `main`
* **Reviewed:** 2026-01-21 (REVISED)
* **Status:** OPEN

---

## Summary

This PR adds unit tests for the ROCm Linux packaging scripts (`packaging_utils.py` and `build_package.py`). The tests cover input validation, metadata extraction, package creation logic for both DEB and RPM formats.

**Net changes:** +2248 lines across 3 files

---

## Overall Assessment

**‚ö†Ô∏è CHANGES REQUESTED** - The test suite has fundamental issues that need to be addressed before it provides value.

**Issues:**
- Many tests are useless (testing standard library, over-mocking)
- Change detector tests that will break on any refactor
- Excessive patching that obscures test intent
- Documentation includes stale information
- File naming doesn't match project conventions

---

## Detailed Review

### 1. `test_linux_packaging_utils.py`

#### ‚ùå BLOCKING: Useless test for trivial wrapper

**Location:** Lines 1424-1439, `TestPrintFunctionName`

The `print_function_name()` function just calls `print()`. Testing it provides no value.

```python
# The function being tested:
def print_function_name():
    print(f"In function: {inspect.stack()[1].function}")

# This test is useless - we're testing print() works
def test_print_function_name(self, mock_print):
    ...
```

**Required action:** Remove this test class entirely.

#### ‚ùå BLOCKING: Over-mocking defeats test purpose

**Location:** Lines 1441-1463, `TestReadPackageJsonFile`

The test mocks `Path.open`, so it's testing that `json.load()` works on mocked data, not that the function correctly reads the real `package.json`.

```python
# BAD: Mocks the file read
@patch("pathlib.Path.open", new_callable=mock_open, read_data='[{"Package": "test-pkg"}]')
def test_read_package_json_file_success(self, mock_file):
    result = packaging_utils.read_package_json_file()
    self.assertEqual(result, [{"Package": "test-pkg"}])
```

**Required action:** Use the real `package.json` file:
```python
def test_read_package_json_file_success(self):
    result = packaging_utils.read_package_json_file()
    # Verify known packages exist
    packages = [p["Package"] for p in result]
    self.assertIn("amdrocm-llvm", packages)
```

#### ‚ùå BLOCKING: Change detector tests

**Location:** Lines 1465-1532, `TestIsKeyDefined`

These tests duplicate the `true_values` and `false_values` lists from the implementation. They'll break on any implementation change without catching actual bugs.

```python
# BAD: Mirrors implementation
def test_key_true_values(self):
    true_values = ["1", "true", "t", "yes", "y", "on", "enable", "enabled", "found", ...]
    for val in true_values:
        self.assertTrue(is_key_defined({"TestKey": val}, "TestKey"))
```

**Required action:** Test with real package data:
```python
def test_key_defined_in_real_package(self):
    packages = read_package_json_file()
    pkg = next(p for p in packages if p["Package"] == "amdrocm-llvm")
    self.assertTrue(is_key_defined(pkg, "Postinstall"))
    self.assertFalse(is_key_defined(pkg, "NonExistentKey"))
```

#### ‚ùå BLOCKING: Testing trivial wrappers

**Location:** Lines 1534-1574, multiple test classes

`TestIsPostinstallscriptsAvailable`, `TestIsMetaPackage`, `TestIsCompositePackage`, etc. all test functions that just call `is_key_defined()` with a specific key name. These are trivial wrappers with no logic to test.

**Required action:** Remove these test classes. If `is_key_defined()` works, these work.

#### ‚ùå BLOCKING: Testing standard library

**Location:** Lines 1675-1706, `TestRemoveDir`

Testing `shutil.rmtree()` - we don't need to test the standard library.

**Required action:** Remove this test class.

#### üí° SUGGESTION: Good tests to keep

Lines 1708-1857, `TestVersionToStr` and `TestUpdatePackageName` - These tests ARE useful because they test actual application logic with nontrivial behavior.

### 2. `test_linux_build_package.py`

#### ‚ö†Ô∏è IMPORTANT: Unnecessary print patching

**Location:** Throughout file (lines 261, 275, 289, 304, etc.)

Almost every test patches `@patch("builtins.print")`. This is unnecessary - logging during tests is fine.

**Recommendation:** Remove all `@patch("builtins.print")` decorators.

#### ‚ùå BLOCKING: Excessive patching

**Location:** Lines 960-1023, `TestCreateVersionedDebPackage.test_create_versioned_deb_with_artifacts`

This test has 14 patches. It's testing that mocks are called in order, not actual behavior.

**Required action:** Rewrite with real temp files, mock only `dpkg-buildpackage`:
```python
def test_create_versioned_deb_with_artifacts(self, tmp_path):
    # Set up real files in tmp_path
    # Mock only the external tool (dpkg-buildpackage)
    # Verify actual output files exist with correct content
```

#### ‚ùå BLOCKING: Testing argparse

**Location:** Lines 886-912, `TestMain`

Testing that argparse parses arguments is testing the standard library.

**Required action:** Remove this test class or rewrite to test business logic.

### 3. `LINUX_PACKAGING_TEST_README.md`

#### ‚ùå BLOCKING: Stale information

**Location:** Lines 1-15

```markdown
<!-- BAD: Will go stale immediately -->
...with **96% code coverage**.
- `test_linux_packaging_utils.py` - 54 tests for `packaging_utils.py` (99% coverage)
- `test_linux_build_package.py` - 36 tests for `build_package.py` (94% coverage)
```

**Required action:** Remove specific counts and percentages. Use evergreen language:
```markdown
This directory contains unit tests for the packaging scripts.
Run `pytest --cov` to see current coverage.
```

#### ‚ö†Ô∏è IMPORTANT: Generic instructions

**Location:** Lines 16-62

Instructions for running `python3 -m unittest` are generic to any Python project. Don't duplicate standard tool documentation.

**Recommendation:** Replace with project-specific info only, link to central testing docs.

#### ‚ö†Ô∏è IMPORTANT: Wrong location for testing practices

**Location:** Lines 127-154

Testing practices documentation belongs in the style guide at `docs/development/style_guides/python_style_guide.md`, not in a nested README.

**Recommendation:** Move to style guide or remove.

### 4. File Naming Convention

#### ‚ö†Ô∏è IMPORTANT: Wrong naming pattern

Files are named `test_*.py` but TheRock uses `*_test.py` convention.

**Recommendation:** Rename to:
- `linux_packaging_utils_test.py`
- `linux_build_package_test.py`

---

## Recommendations

### ‚ùå REQUIRED Before Human Review (Blocking):

1. Remove useless tests (print_function_name, remove_dir, trivial wrappers)
2. Rewrite tests that mock the thing being tested to use real files
3. Remove change detector tests that mirror implementation
4. Remove tests for standard library (argparse)
5. Reduce excessive patching - aim for <5 patches per test
6. Remove stale information from README (counts, percentages)

### ‚úÖ Recommended Before Human Review:

1. Remove unnecessary `@patch("builtins.print")` throughout
2. Rename files to match `*_test.py` convention
3. Move testing practices docs to style guide
4. Add tests to CI workflow

### üí° Consider:

1. Use the real `package.json` file in tests
2. Add integration tests that verify actual file output

---

## Testing Recommendations

After addressing the above issues, verify the remaining tests:

```bash
cd TheRock/build_tools/packaging/tests
pytest -v
```

---

## Conclusion

**Approval Status: ‚ö†Ô∏è CHANGES REQUESTED**

This PR needs significant rework. Many tests add maintenance burden without providing value because they test standard library functions, use excessive mocking, or are change detector tests. The documentation contains information that will go stale and duplicates standard tool documentation.

Focus on tests that verify actual application logic with real files, not tests that verify mocks are called in order.
