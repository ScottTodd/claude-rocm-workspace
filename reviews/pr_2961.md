# PR Review: #2961 - Add "gha_query_workflow_runs_for_commit" utility function

* **PR:** https://github.com/ROCm/TheRock/pull/2961
* **Author:** ScottTodd
* **Branch:** `github-actions-query-workflow-runs` ‚Üí `main`
* **Reviewed:** 2026-01-15

---

## Summary

Adds a new `gha_query_workflow_runs_for_commit()` utility function to query GitHub API for workflow runs associated with a specific commit SHA. Also renames `gha_query_workflow_run_information` to `gha_query_workflow_run_by_id` with improved documentation, and optimizes `retrieve_bucket_info()` to accept an optional pre-fetched `workflow_run` dict to avoid redundant API calls.

**Net changes:** +143 lines, -50 lines across 2 files

---

## Overall Assessment

**‚úÖ APPROVED** - Well-structured addition with good test coverage and clear documentation.

**Strengths:**
- Excellent docstrings with clear parameter descriptions, return types, and API references
- Good test coverage including contract verification for required response fields
- The `workflow_run` parameter optimization in `retrieve_bucket_info()` is a good design choice
- Refactored conditional logic eliminates code duplication
- Tests cover both positive cases (commit with runs) and negative cases (commit without runs)

**Minor Observations:**
- Function rename may need backwards compatibility alias (see below)

---

## Detailed Review

### 1. github_actions_utils.py

#### ‚ö†Ô∏è IMPORTANT: Backwards Compatibility for Function Rename

The function `gha_query_workflow_run_information` was renamed to `gha_query_workflow_run_by_id` without a backwards compatibility alias. If any existing code (internal or external) calls the old function name, this will break.

**Recommendation:** Consider adding an alias:
```python
# Backwards compatibility alias
gha_query_workflow_run_information = gha_query_workflow_run_by_id
```

*Note: PR body mentions merge conflicts with #2931 - this may already be handled there.*

#### ‚úÖ Good: New Function Documentation

`gha_query_workflow_runs_for_commit()` has excellent documentation:
- Clear description of what the function does
- Documents the API endpoint used
- Notes about pagination limits (30 results by default)
- Explains ordering (most recent first)
- Clear return type annotation (`list[dict]`)

#### ‚úÖ Good: retrieve_bucket_info() Refactoring

The refactored logic is cleaner:
```python
# Fetch workflow_run from API if not provided but workflow_run_id is set
if workflow_run is None and workflow_run_id is not None:
    workflow_run = gha_query_workflow_run_by_id(github_repository, workflow_run_id)

# Extract metadata from workflow_run if available
if workflow_run is not None:
    # Single code path for both provided and fetched workflow_run
```

This eliminates the previous duplication where the same metadata extraction was repeated in two branches.

### 2. github_actions_utils_test.py

#### ‚úÖ Good: Contract Verification Tests

The tests verify that API responses contain the fields used downstream:
```python
self.assertIn("id", workflow_run)
self.assertIn("head_repository", workflow_run)
self.assertIn("full_name", workflow_run["head_repository"])
self.assertIn("updated_at", workflow_run)
self.assertIn("status", workflow_run)
self.assertIn("html_url", workflow_run)
```

This is valuable for catching API changes that could break dependent code.

#### ‚úÖ Good: Negative Case Testing

`test_gha_query_workflow_runs_for_commit_not_found` verifies that a non-existent commit returns an empty list (not an exception), which is the correct behavior.

#### ‚úÖ Good: Test Organization

Tests are reorganized to group workflow run query tests together, improving readability.

---

## Recommendations

### ‚úÖ Recommended Before Human Review:

1. **Consider backwards compatibility alias** for `gha_query_workflow_run_information` if external callers exist (or confirm this is handled in #2931)

### üí° Consider:

1. The PR description mentions this is part of a larger stack - ensure merge conflicts with #2931 are resolved cleanly

### üìã Future Follow-up:

1. Consider adding pagination support to `gha_query_workflow_runs_for_commit()` if use cases emerge that need more than 30 results per commit

---

## Testing Recommendations

```bash
# Run the unit tests (requires GITHUB_TOKEN for API tests)
cd build_tools/github_actions
python -m unittest tests.github_actions_utils_test -v

# Or run specific new tests
python -m unittest tests.github_actions_utils_test.GitHubActionsUtilsTest.test_gha_query_workflow_runs_for_commit_found
python -m unittest tests.github_actions_utils_test.GitHubActionsUtilsTest.test_gha_query_workflow_runs_for_commit_not_found
```

---

## Conclusion

**Approval Status: ‚úÖ APPROVED**

This is a clean, well-documented addition that provides useful functionality for the artifact lookup tooling. The test coverage is good, and the code follows existing patterns in the codebase. The only minor concern is backwards compatibility for the renamed function, which may already be handled in the related PR #2931.
