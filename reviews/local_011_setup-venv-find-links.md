# Branch Review: setup-venv-find-links

* **Branch:** `setup-venv-find-links`
* **Base:** `main`
* **Reviewed:** 2026-02-03
* **Commits:** 8 commits

---

## Summary

This PR adds `--find-links-url` support to `setup_venv.py` for installing packages from flat pip indexes (used for CI-built wheels), and includes a significant refactoring to improve code clarity and testability. The refactoring extracts `install_packages_into_venv()` as a standalone function with explicit parameters, simplifies the pip/uv branching logic, and cleans up the `scrape_subdirs()` function.

**Net changes:** +232 lines, -115 lines across 2 files

---

## Overall Assessment

**âœ… APPROVED** - Code is well-structured, tests are appropriate, and the new functionality is cleanly implemented.

**Strengths:**
- Clean extraction of `install_packages_into_venv()` with explicit parameters improves testability
- Good test coverage for the new functionality
- Simplified `_scrape_rocm_index_subdirs()` is much more readable
- Docstrings added to key functions
- Proper error handling for conflicting `index_url` and `index_name`

**No blocking issues found.**

---

## Detailed Review

### 1. setup_venv.py - Core Changes

**Feature: `--find-links-url` support**

The new `--find-links-url` argument enables installing from flat pip indexes (generated by `indexer.py`), which is needed for CI workflows that upload wheels to S3. This can be used alone or alongside `--index-url`.

```python
if find_links_url:
    pip_install_cmd.append(f"--find-links={find_links_url}")
```

This correctly allows both flags together, matching pip's semantics.

**Refactoring: `install_packages_into_venv()`**

The extraction of this function with explicit parameters is a significant improvement:

```python
def install_packages_into_venv(
    venv_dir: Path,
    packages: list[str],
    use_uv: bool = False,
    index_url: str | None = None,
    index_name: str | None = None,
    index_subdir: str | None = None,
    find_links_url: str | None = None,
    disable_cache: bool = False,
):
```

This makes the function testable in isolation and the API self-documenting.

**Refactoring: `_scrape_rocm_index_subdirs()`**

The simplification from complex union type to simple `set[str] | None` is much cleaner:

```python
# Before: dict[str, set[str]] | set[str] | None with "congruent" logic
# After: set[str] | None (union of all subdirs)
```

### ðŸ’¡ SUGGESTION: Consider adding `--pre` flag support

For dev/nightly builds, users typically need `--pre` to install pre-release versions. Consider adding a `--pre` flag that maps to pip's `--pre` option.

### ðŸ’¡ SUGGESTION: Docstring for `run()` function

The `run()` function orchestrates the main workflow but lacks a docstring. Consider adding one for consistency.

### 2. setup_venv_test.py - Tests

**Good test coverage:**
- `test_basic_usage` - verifies minimal usage
- `test_index_url_complete` - URL used as-is
- `test_index_name_with_subdir` - shorthand expansion
- `test_index_url_with_subdir` - URL + subdir combination
- `test_find_links_only` - new functionality
- `test_index_url_and_find_links` - both together

Tests correctly mock `run_command` and verify the generated pip command contains expected flags.

### ðŸ’¡ SUGGESTION: Add test for `disable_cache` flag

There's no test verifying that `disable_cache=True` adds `--no-cache-dir` to the command.

### ðŸ’¡ SUGGESTION: Add test for `use_uv=True` path

The tests only exercise the pip path. Consider adding a test for the uv path to ensure it generates the correct command structure.

---

## Recommendations

### âœ… Recommended Before Human Review:

1. Consider adding a simple test for `disable_cache=True` behavior
2. Consider adding a test for `use_uv=True` to exercise that code path

### ðŸ’¡ Consider:

1. Add `--pre` flag support for pre-release installations
2. Add docstring to `run()` function

### ðŸ“‹ Future Follow-up:

1. Add `--find-links-url` support to `build_prod_wheels.py` for PyTorch builds
2. Rename `cloudfront_url` to `index_url` in PyTorch workflows

---

## Testing Recommendations

```bash
# Run the unit tests
python -m pytest build_tools/tests/setup_venv_test.py -v

# Manual testing with real packages (optional)
python build_tools/setup_venv.py .venv-test \
  --packages "rocm" \
  --index-name nightly \
  --index-subdir gfx110X-all

# Test --find-links-url with a local index
python build_tools/setup_venv.py .venv-test \
  --packages "rocm" \
  --find-links-url "file:///path/to/local/index.html"
```

---

## Conclusion

**Approval Status: âœ… APPROVED**

This PR is ready for human review. The code is well-structured, the new functionality is cleanly implemented, and test coverage is adequate. The refactoring significantly improves code clarity and testability. The suggestions above are optional improvements that could be addressed in follow-up work.
