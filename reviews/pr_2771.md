# PR Review: Deduplicate TheRock CI

* **PR:** [#2771](https://github.com/ROCm/TheRock/pull/2771)
* **Title:** Deduplicate TheRock CI
* **Author:** jayhawk-commits (Joseph Macaranas)
* **Reviewed:** 2026-01-15 (Re-reviewed with GitHub Actions guidelines)
* **Status:** MERGED
* **Net changes:** +2177 lines, -208 lines across 17 files

---

## Summary

This PR implements CI deduplication by centralizing GPU family matrices and CI logic in TheRock, eliminating duplication across rocm-libraries and rocm-systems repositories.

**Main changes:**
- Added external repo detection and configuration (`detect_external_repo_config.py`, `external_repo_project_maps.py`)
- Enhanced `configure_ci.py` with external repo support
- Updated 10 workflow files with external checkout support
- Added `test_external_repo_integration.yml` workflow
- Added 3 test files with 22+ test cases

---

## Overall Assessment

**‚ö†Ô∏è CHANGES REQUESTED** - This PR has blocking issues related to incomplete caller updates for reusable workflow changes.

**Strengths:**
- Excellent PR description with architecture diagrams
- Good test coverage for new functionality
- Clean separation of concerns in new Python modules

**Blocking Issues:**
- Incomplete caller updates for `setup.yml` changes
- Input propagation breaking change not handled for all callers
- Missing trigger path testing for `workflow_dispatch` on affected callers

---

## Detailed Review (GitHub Actions Guidelines Applied)

### ‚ùå BLOCKING: Incomplete Caller Updates for setup.yml

Per [github_actions.md](guidelines/github_actions.md#reusable-workflow-changes), when modifying a reusable workflow, **all callers must be verified**.

**Callers of `setup.yml`:**
```
.github/workflows/ci.yml              ‚úÖ Updated in PR
.github/workflows/ci_asan.yml         ‚ùå NOT updated
.github/workflows/ci_nightly.yml      ‚ùå NOT updated
.github/workflows/multi_arch_ci.yml   ‚ùå NOT updated
```

**Impact:** The PR changed `setup.yml` to use `inputs.linux_amdgpu_families` instead of `github.event.inputs.linux_amdgpu_families`. Callers that don't pass this input explicitly will receive empty values.

**Evidence of regression:** Post-merge comment from mgehre-amd:
> "Since today, I cannot manually run CI Nightly jobs anymore. They behave as-if I didn't specify any amdgpu family in the workflow dispatch on the github UI even though I did."

**Required action:** Update `ci_nightly.yml`, `ci_asan.yml`, and `multi_arch_ci.yml` to pass GPU family inputs:
```yaml
uses: ./.github/workflows/setup.yml
with:
  build_variant: "release"
  linux_amdgpu_families: ${{ github.event.inputs.linux_amdgpu_families }}
  windows_amdgpu_families: ${{ github.event.inputs.windows_amdgpu_families }}
  # ... other inputs
```

---

### ‚ùå BLOCKING: Input Propagation Breaking Change

Per [github_actions.md](guidelines/github_actions.md#input-propagation), switching from `github.event.inputs` to `inputs` is a **breaking change** for `workflow_dispatch`.

**The change in `setup.yml`:**
```yaml
# BEFORE (worked for workflow_dispatch)
INPUT_LINUX_AMDGPU_FAMILIES: ${{ github.event.inputs.linux_amdgpu_families }}

# AFTER (only works for workflow_call)
INPUT_LINUX_AMDGPU_FAMILIES: ${{ inputs.linux_amdgpu_families }}
```

**Problem:** `inputs.*` only receives values from `workflow_call`. For `workflow_dispatch`, user inputs go to `github.event.inputs.*`. The PR updated `ci.yml` to pass inputs, but not other callers.

**Required action:** Either:
1. Update all callers to pass inputs explicitly (preferred), OR
2. Use fallback pattern: `${{ inputs.linux_amdgpu_families || github.event.inputs.linux_amdgpu_families }}`

---

### ‚ùå BLOCKING: Missing Trigger Path Testing

Per [github_actions.md](guidelines/github_actions.md#testing-trigger-paths), each trigger type must be tested.

**PR testing evidence:**
- ‚úÖ `pull_request` on TheRock: [Run #10715](https://github.com/ROCm/TheRock/actions/runs/21012755732)
- ‚úÖ `workflow_call` external integration: [Run #50](https://github.com/ROCm/TheRock/actions/runs/21012755816)
- ‚ùå `workflow_dispatch` on `ci_nightly.yml`: NOT TESTED
- ‚ùå `workflow_dispatch` on `ci_asan.yml`: NOT TESTED

**Required action:** Test `workflow_dispatch` on all affected callers before approving workflow input changes.

---

### ‚ö†Ô∏è IMPORTANT: Caller Inventory Missing from PR Description

The PR description should list all callers of modified reusable workflows and explain how each is handled:

```markdown
## Callers of setup.yml

| Caller | Status | Notes |
|--------|--------|-------|
| ci.yml | Updated | Passes new inputs |
| ci_nightly.yml | Unchanged | Uses workflow_dispatch defaults |
| ci_asan.yml | Unchanged | Uses presubmit defaults |
| multi_arch_ci.yml | Unchanged | Uses presubmit defaults |
```

---

### üí° SUGGESTION: Use `!contains(github.repository, 'TheRock')` Consistently

Several job names use this pattern to detect external repos:
```yaml
name: ${{ !contains(github.repository, 'TheRock') && format('...') || '...' }}
```

This is fragile - a fork named "MyTheRockFork" would match. Where `inputs.external_source_checkout` is available, prefer:
```yaml
name: ${{ inputs.external_source_checkout && format('...') || '...' }}
```

---

## Recommendations

### ‚ùå REQUIRED Before Human Review (Blocking):

1. **Update all callers of `setup.yml`** to pass GPU family inputs:
   - `ci_nightly.yml`
   - `ci_asan.yml`
   - `multi_arch_ci.yml`

2. **Test `workflow_dispatch`** on ci_nightly.yml with explicit GPU family inputs

3. **Add caller inventory** to PR description for modified reusable workflows

### ‚úÖ Recommended Before Human Review:

1. Document the `inputs` vs `github.event.inputs` change in commit message
2. Consider fallback pattern for backwards compatibility

### üí° Consider:

1. Use `inputs.external_source_checkout` instead of repository name checks where possible

---

## Testing Recommendations

**Before approving changes to reusable workflows, verify:**

```markdown
## Trigger Path Testing

- [ ] `workflow_dispatch` on ci.yml: [Run #___](link)
- [ ] `workflow_dispatch` on ci_nightly.yml: [Run #___](link)
- [ ] `workflow_dispatch` on ci_asan.yml: [Run #___](link)
- [ ] `workflow_call` from external repo: [Run #___](link)
- [ ] `pull_request` standard CI: [Run #___](link)
```

---

## Conclusion

**Approval Status: ‚ö†Ô∏è CHANGES REQUESTED**

This PR introduced a regression by changing `setup.yml` input handling without updating all callers. The `ci_nightly.yml` workflow_dispatch functionality broke because it wasn't updated to pass the new required inputs.

**Lessons learned:**
1. When modifying reusable workflows, enumerate ALL callers
2. Changing from `github.event.inputs` to `inputs` requires caller updates
3. Test each trigger type separately - `workflow_dispatch` behaves differently from `workflow_call`

A follow-up PR is needed to fix `ci_nightly.yml`, `ci_asan.yml`, and `multi_arch_ci.yml`.
