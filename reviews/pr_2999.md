# PR Review: #2999 ‚Äî Add new workflow to support JAX branches and Python support

* **PR:** [#2999](https://github.com/ROCm/TheRock/pull/2999)
* **Author:** kiran-thumma
* **Branch:** `users/kithumma/jax-branches-python-support` ‚Üí `main`
* **Reviewed:** 2026-02-18
* **State:** OPEN

---

## Summary

Refactors the JAX wheels build/release pipeline to match the PyTorch wheels pattern: a new `release_portable_linux_jax_wheels.yml` acts as a matrix orchestrator between `release_portable_linux_packages.yml` and `build_linux_jax_wheels.yml`. Also separates `ROCm/rocm-jax` (build scripts + plugin) from `ROCm/jax` (jaxlib source) into distinct checkout directories, and bumps the default JAX ref from `rocm-jaxlib-v0.8.0-fixdevtar` to `rocm-jaxlib-v0.8.2`.

**Net changes:** +146 lines, -27 lines across 4 files

**Workflow architecture after this PR:**
```
release_portable_linux_packages.yml
    ‚Üì benc-uk/workflow-dispatch (workflow_dispatch)
release_portable_linux_jax_wheels.yml      ‚Üê NEW
    ‚Üì matrix: [py3.12] √ó [rocm-jaxlib-v0.8.2]  (workflow_call)
build_linux_jax_wheels.yml
    ‚Üì workflow_call
test_linux_jax_wheels.yml
```

---

## Overall Assessment

**‚ö†Ô∏è CHANGES REQUESTED** ‚Äî The architecture is sound and follows established patterns. There are no correctness bugs in the workflow plumbing. However, there is an important concern about a shared ref being used for two different repositories, the PR description contains claims that don't match the actual diff, and there is no test evidence linked.

**Strengths:**

- Clean separation of `rocm-jax` (build scripts/plugin) and `jax` (jaxlib source) into distinct checkouts
- Follows the established PyTorch release workflow pattern (`release_portable_linux_pytorch_wheels.yml`)
- Properly adds `ref` parameter to the `benc-uk/workflow-dispatch` call (previously missing)
- Canonical `ROCm/` org name used consistently (fixes `rocm/`)
- `fail-fast: false` for release builds
- Input propagation through the `workflow_dispatch` ‚Üí `workflow_call` chain is correct

**Issues:**

- ‚ö†Ô∏è Same `jax_ref` used for both `ROCm/rocm-jax` and `ROCm/jax` ‚Äî unclear if branch names match across repos
- ‚ö†Ô∏è PR description makes claims about changes that are not reflected in the diff
- ‚ö†Ô∏è No test evidence linked for any trigger path

---

## Detailed Review

### 1. `release_portable_linux_jax_wheels.yml` (NEW)

This is the core addition ‚Äî a matrix orchestrator workflow. The structure closely mirrors `release_portable_linux_pytorch_wheels.yml`.

**Input propagation is correct.** All inputs from `workflow_dispatch` are forwarded to `build_linux_jax_wheels.yml` via `workflow_call`. The matrix provides `python_version` and `jax_ref`.

### üí° SUGGESTION: 1√ó1 matrix adds indirection for a single combination

The matrix is currently:
```yaml
python_version: ["3.12"]
jax_ref: ["rocm-jaxlib-v0.8.2"]
```

This is a 1√ó1 matrix ‚Äî one Python version, one JAX branch. The workflow adds an indirection layer that currently dispatches exactly one downstream job. This is fine as scaffolding for future expansion (as described in the PR), but worth noting.

---

### 2. `build_linux_jax_wheels.yml`

Good changes overall:

- Removed the internal `matrix: jax_ref: [...]` strategy (moved to calling workflow)
- Split single `rocm/rocm-jax` checkout into `ROCm/rocm-jax` + `ROCm/jax`
- Updated `PACKAGE_DIST_DIR` to match new directory layout
- Added `--jax-source-dir` flag to `ci_build` command

### ‚ö†Ô∏è IMPORTANT: Shared `jax_ref` used for two different repositories

Both checkouts use `${{ inputs.jax_ref }}` (default `rocm-jaxlib-v0.8.2`):

```yaml
- name: Checkout rocm-jax
  with:
    repository: ROCm/rocm-jax
    ref: ${{ inputs.jax_ref }}          # ‚Üê same ref

- name: Checkout JAX (source for jaxlib build)
  with:
    repository: ROCm/jax
    ref: ${{ inputs.jax_ref }}          # ‚Üê same ref
```

`ROCm/rocm-jax` and `ROCm/jax` are different repositories. The branch `rocm-jaxlib-v0.8.2` needs to exist in both. If these repos use different branch naming conventions now or in the future, this will fail silently (checkout failure) or build the wrong combination.

**Recommendation:** Verify that `ROCm/jax` has a `rocm-jaxlib-v0.8.2` branch. Consider whether a separate `jax_source_ref` input is warranted, or add a comment explaining the shared-ref convention.

---

### 3. `release_portable_linux_packages.yml`

The changes here are minimal and correct:

```diff
-          workflow: build_linux_jax_wheels.yml
+          workflow: release_portable_linux_jax_wheels.yml
+          ref: ${{ inputs.ref || github.ref_name }}
...
-              "python_version": "3.12",
```

- `workflow` target updated ‚úì
- `ref` added (was previously missing ‚Äî this is a real fix) ‚úì
- `python_version` removed (now handled by matrix) ‚úì
- All other inputs pass through unchanged ‚úì

### ‚ö†Ô∏è IMPORTANT: PR description claims don't match the diff

The PR description states:
> - **Fixed S3 path handling**: Changed `s3_subdir` from `S3_STAGING_SUBDIR` to `S3_SUBDIR`
> - **Added missing parameters**: `s3_staging_subdir`, `cloudfront_url`, `cloudfront_staging_url`, and `ref`

The diff shows `"s3_subdir": "${{ env.S3_SUBDIR }}"` as **unchanged context** ‚Äî it was already `S3_SUBDIR` on main. Similarly, `s3_staging_subdir`, `cloudfront_url`, and `cloudfront_staging_url` appear in the unchanged context, meaning they were already being passed. Only `ref` was actually added.

This is a documentation-only issue, but inaccurate PR descriptions undermine reviewer trust. The description should be corrected to accurately reflect what changed.

---

### 4. `test_linux_jax_wheels.yml`

Good changes:

- Updated defaults from `rocm-jaxlib-v0.8.0-fixdevtar` to `rocm-jaxlib-v0.8.2`
- Directory layout matches build workflow: `rocm-jax` for plugin, `jax` for source/tests
- Test paths updated from `jax/jax_tests/tests/*.py` to `jax/tests/*.py`
- Canonical `ROCm/` org name used
- `jax-requirements` path updated to `rocm-jax/build/requirements.txt`

### üí° SUGGESTION: Removed fallback for `jax_ref` in checkout

The old code had:
```yaml
ref: ${{ inputs.jax_ref || 'rocm-jaxlib-v0.8.0-fixdevtar' }}
```

The new code uses:
```yaml
ref: ${{ inputs.jax_ref }}
```

The fallback is no longer needed since the input has a default value. This is fine ‚Äî just noting the behavior change. If `jax_ref` were ever passed as an empty string, checkout would use the repo's default branch instead of the hardcoded fallback. For `workflow_call` this can't happen (the caller sets it), and for `workflow_dispatch` the default is set. So this is correct.

---

## Recommendations

### ‚ö†Ô∏è Recommended Before Human Review:

1. **Verify shared `jax_ref` works for both repos** ‚Äî Confirm `ROCm/jax` has a `rocm-jaxlib-v0.8.2` branch. If the repos use different branch naming in the future, consider adding a separate `jax_source_ref` input.
2. **Fix PR description** ‚Äî Remove or correct the claims about "Fixed S3 path handling" and "Added missing parameters" (`s3_staging_subdir`, `cloudfront_url`, `cloudfront_staging_url`) that were already present on main. Only `ref` was actually added.
3. **Add test evidence** ‚Äî Link to CI runs showing the workflow works for at least `workflow_dispatch` of the new `release_portable_linux_jax_wheels.yml`. The test plan lists several verification items but none are checked off.

### üí° Consider:

1. The 1√ó1 matrix is fine as scaffolding, but could add a comment noting which Python versions / JAX branches are planned for future expansion.

---

## Testing Recommendations

- Trigger `release_portable_linux_jax_wheels.yml` via `workflow_dispatch` from the PR branch and confirm both `ROCm/rocm-jax` and `ROCm/jax` checkouts succeed with the `rocm-jaxlib-v0.8.2` ref.
- Trigger `build_linux_jax_wheels.yml` via `workflow_dispatch` to verify the build still works with the new two-repo checkout layout.
- Verify `test_linux_jax_wheels.yml` finds tests at the new `jax/tests/*.py` paths.
- Confirm `release_portable_linux_packages.yml` end-to-end (or at least verify the dispatch step triggers the right workflow on the right ref).

---

## Conclusion

**Approval Status: ‚ö†Ô∏è CHANGES REQUESTED**

The workflow architecture is solid and correctly follows the established PyTorch pattern. The separation of `rocm-jax` and `jax` checkouts is a real improvement. The main concerns are: (1) verifying that the shared `jax_ref` branch name exists in both target repositories, (2) correcting the PR description to match the actual diff, and (3) providing test evidence. None of these are code bugs ‚Äî once addressed, this should be ready for merge.
