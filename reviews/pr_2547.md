# PR Review: Generate a manifest file for Pytorch builds

* **PR:** [#2547](https://github.com/ROCm/TheRock/pull/2547)
* **Author:** erman-gurses
* **Base:** `main`
* **Branch:** `users/erman-gurses/add-pytorch-manifest`
* **Reviewed:** 2026-01-12
* **Status:** OPEN
* **Closes:** #2481

---

## Summary

This PR introduces a manifest file generator for PyTorch external builds. The manifest captures metadata about built wheels (version, size, labels), source repository information (git commits, remotes), and CI context (run ID, job ID). The manifest is generated as part of `build_prod_wheels.py` and uploaded to S3 alongside the wheel artifacts.

**Net changes:** +628 lines, -3 lines across 5 files

**Files changed:**
- `.github/workflows/build_portable_linux_pytorch_wheels.yml` (+20/-3)
- `.github/workflows/build_windows_pytorch_wheels.yml` (+18/-0)
- `external-builds/pytorch/build_prod_wheels.py` (+54/-0)
- `external-builds/pytorch/generate_pytorch_manifest.py` (+298/-0) - new file
- `external-builds/pytorch/tests/test_generate_pytorch_manifest.py` (+238/-0) - new file

---

## Overall Assessment

**‚ö†Ô∏è CHANGES REQUESTED** - The implementation is solid overall with good test coverage, but there are issues in the Windows workflow that will likely cause CI failures.

**Strengths:**
- Well-structured manifest format with comprehensive metadata
- Good separation of concerns - manifest generation is a separate script
- Solid test coverage (238 lines of tests) for wheel parsing and manifest generation
- Proper use of environment variables for CI context
- Follows PEP 427 for wheel name parsing
- Error handling with warnings for non-critical git failures (reasonable for optional metadata)

**Blocking/Important Issues:**
- Windows workflow has shell syntax issues (mixing bash and cmd commands)
- Windows manifest upload step has critical bugs that will cause CI failures

---

## Detailed Review

### 1. `.github/workflows/build_portable_linux_pytorch_wheels.yml`

**Overall:** Good implementation with proper variable handling.

#### ‚úÖ GOOD: Proper manifest path construction

The shell variable expansion and path construction are correct:
```yaml
PY="${{ inputs.python_version }}"; PY="${PY#py}"
TRACK="${{ inputs.pytorch_git_ref }}"; TRACK="${TRACK//\//-}"
```

#### ‚úÖ GOOD: File existence validation

The step validates the manifest file exists before upload:
```yaml
test -f "${{ env.PACKAGE_DIST_DIR }}/manifests/${MANIFEST_NAME}"
```

---

### 2. `.github/workflows/build_windows_pytorch_wheels.yml`

#### ‚ùå BLOCKING: Critical shell syntax errors in Windows manifest upload step

**Location:** Lines 260-275

The Windows workflow step has multiple critical issues:

```yaml
shell: cmd
run: |
  set "PY=${{ inputs.python_version }}"
  if "%PY:~0,2%"=="py" set "PY=%PY:~2%"
  set "MANIFEST_NAME=therock-manifest_torch_py%PY%_${{ inputs.pytorch_git_ref }}.json"
  set "MANIFEST_NAME=%MANIFEST_NAME:/=-%"
  echo "Available manifest files:"
  ls -l "${PACKAGE_DIST_DIR}/manifests" || dir "${PACKAGE_DIST_DIR}\manifests"
```

**Issues:**
1. **`ls -l` is not available in cmd.exe** - This is a Unix command. Should use `dir` only.
2. **Mixed shell syntax** - `${PACKAGE_DIST_DIR}` is bash syntax, not cmd. In cmd, use `%PACKAGE_DIST_DIR%`.
3. **Bash string substitution in cmd** - `%MANIFEST_NAME:/=-%` is an attempt to replace `/` with `-` but this cmd syntax replaces from start of string, not globally. Should use a different approach.
4. **No file existence check** - Unlike the Linux step which has `test -f`, Windows step has no validation before S3 upload.

**Required action:** Change to bash shell for consistency with Linux, or fix all cmd.exe syntax issues:

**Option 1 (Recommended) - Use bash shell:**
```yaml
- name: Upload PyTorch manifest to S3 artifacts
  if: ${{ github.repository_owner == 'ROCm' }}
  shell: bash
  run: |
    PY="${{ inputs.python_version }}"; PY="${PY#py}"
    TRACK="${{ inputs.pytorch_git_ref }}"; TRACK="${TRACK//\//-}"
    MANIFEST_NAME="therock-manifest_torch_py${PY}_${TRACK}.json"
    echo "Manifest expected at: ${{ env.PACKAGE_DIST_DIR }}/manifests/${MANIFEST_NAME}"
    ls -la "${{ env.PACKAGE_DIST_DIR }}/manifests" || true
    test -f "${{ env.PACKAGE_DIST_DIR }}/manifests/${MANIFEST_NAME}"
    aws s3 cp \
      "${{ env.PACKAGE_DIST_DIR }}/manifests/${MANIFEST_NAME}" \
      "s3://${{ env.S3_BUCKET_ARTIFACTS }}/${{ github.run_id }}-windows/manifests/${{ inputs.amdgpu_family }}/${MANIFEST_NAME}"
```

**Option 2 - Fix cmd.exe syntax:**
```yaml
- name: Upload PyTorch manifest to S3 artifacts
  if: ${{ github.repository_owner == 'ROCm' }}
  shell: cmd
  run: |
    set "PY=${{ inputs.python_version }}"
    if "%PY:~0,2%"=="py" set "PY=%PY:~2%"
    set "TRACK=${{ inputs.pytorch_git_ref }}"
    set "TRACK=%TRACK:/=-%"
    set "MANIFEST_NAME=therock-manifest_torch_py%PY%_%TRACK%.json"
    echo Available manifest files:
    dir "%PACKAGE_DIST_DIR%\manifests"
    if not exist "%PACKAGE_DIST_DIR%\manifests\%MANIFEST_NAME%" (
      echo ERROR: Manifest not found: %MANIFEST_NAME%
      exit /b 1
    )
    aws s3 cp ^
      "%PACKAGE_DIST_DIR%\manifests\%MANIFEST_NAME%" ^
      "s3://%S3_BUCKET_ARTIFACTS%/%GITHUB_RUN_ID%-windows/manifests/${{ inputs.amdgpu_family }}/%MANIFEST_NAME%"
```

---

### 3. `external-builds/pytorch/build_prod_wheels.py`

#### ‚úÖ GOOD: Proper argument validation

Required arguments are validated when `--write-manifest` is used:
```python
if not args.python_version:
    raise ValueError("--python-version is required for manifest naming")
if not args.pytorch_git_ref:
    raise ValueError("--pytorch-git-ref is required for manifest naming")
```

#### ‚úÖ GOOD: Clear command construction and logging

The manifest generation command is well-constructed with clear logging:
```python
print("[pytorch-manifest] running:", " ".join(map(str, cmd)), flush=True)
```

#### üí° SUGGESTION: Consider earlier argument validation

The validation happens during `do_build()` after potentially long build steps. Consider validating during argument parsing:

```python
build_p.add_argument(
    "--python-version",
    default=None,
    help="Python version for manifest naming (e.g. 3.11, 3.12). Required when --write-manifest is used.",
)
```

And in a custom validation step if `write_manifest` is True.

---

### 4. `external-builds/pytorch/generate_pytorch_manifest.py`

#### ‚úÖ GOOD: Robust error handling for optional git metadata

The `capture()` and `git_head()` functions handle failures gracefully with clear warning messages. Since git metadata is supplementary (not critical to the manifest's core purpose), this approach is reasonable:

```python
except FileNotFoundError:
    print(
        f"  [WARN] Command not found: {cmd[0]} (skipping: {' '.join(cmd)})",
        flush=True,
    )
    return ""
```

This allows builds to proceed even if git commands fail (e.g., shallow clones, missing git binary).

#### ‚úÖ GOOD: Comprehensive manifest content

The manifest includes all essential information:
- Build context (run_id, job_id, platform)
- ROCm-specific metadata (rocm_sdk_version, pytorch_rocm_arch)
- Source provenance (git commits for pytorch, audio, vision, triton)
- Artifact details with parsed wheel labels

#### ‚úÖ GOOD: PEP 427 compliant wheel parsing

The `parse_wheel_name()` function correctly handles:
- Standard wheel format
- Optional build tag
- Version suffixes (e.g., `+rocm7.11.0`)

#### üí° SUGGESTION: Consider adding SHA256 checksums

For integrity verification, consider adding wheel checksums:
```python
import hashlib

def compute_sha256(filepath: Path) -> str:
    sha256 = hashlib.sha256()
    with open(filepath, "rb") as f:
        for chunk in iter(lambda: f.read(8192), b""):
            sha256.update(chunk)
    return sha256.hexdigest()
```

---

### 5. `external-builds/pytorch/tests/test_generate_pytorch_manifest.py`

#### ‚úÖ GOOD: Comprehensive test coverage

The tests thoroughly cover:
- Wheel parsing with and without build tags
- Non-wheel file handling
- Malformed wheel names (too few fields)
- End-to-end manifest generation
- Different `pytorch_git_ref` formats (nightly, release/X.Y)
- GitHub Actions environment simulation
- Proper fixture isolation with environment variable save/restore

#### ‚úÖ GOOD: Proper test documentation

The docstring explains exactly what is and isn't covered, which is helpful for maintainers.

#### üí° SUGGESTION: Add edge case tests

Consider adding tests for:
- Empty wheel directory (no `.whl` files)
- Wheel with unusual version format
- Missing output directory

---

## Security Review

#### ‚úÖ GOOD: No security issues identified

- Command execution uses list args (no shell injection risk)
- Path handling uses `Path.resolve()` (no path traversal)
- Environment variables used safely
- No sensitive data in manifest (git remotes and commits are intentionally public)

---

## Recommendations

### ‚ùå REQUIRED Before Human Review (Blocking):

1. **Fix Windows workflow shell syntax:** The manifest upload step has multiple critical bugs that will cause CI failures. Either:
   - Change to `shell: bash` (recommended for consistency)
   - Fix all cmd.exe syntax issues (ls ‚Üí dir, ${VAR} ‚Üí %VAR%, string substitution)

### ‚úÖ Recommended Before Human Review:

1. **Add file existence validation in Windows workflow:** Match the Linux behavior with a check before S3 upload

### üí° Consider:

1. Add SHA256 checksums to wheel artifacts for integrity verification
2. Add tests for edge cases (empty wheel dir, missing output dir)
3. Consider JSON schema documentation for downstream consumers

### üìã Future Follow-up:

1. Add manifest schema validation step in CI
2. Add manifest consumption tooling/documentation
3. Consider adding architecture label per-artifact (currently at top-level only)

---

## Testing Recommendations

**Run the test suite:**
```bash
pytest external-builds/pytorch/tests/test_generate_pytorch_manifest.py -v
```

**Manual verification:**
1. Verify Windows workflow syntax by testing locally or in a test PR
2. Build wheels and verify manifest is generated with expected structure
3. Compare manifest output against example in PR description

---

## Conclusion

**Approval Status: ‚ö†Ô∏è CHANGES REQUESTED**

This PR adds valuable manifest generation for PyTorch wheel builds with good test coverage and clean implementation. The core functionality is solid. However, the Windows workflow has critical syntax errors that will cause CI failures and must be fixed before merge.

Once the Windows workflow issues are addressed, this will be ready for human review.
